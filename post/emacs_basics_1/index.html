<!doctype html><html lang=es-co><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=author content="Jovany Leandro G.C"><meta name=description content="GNU EMACS es un editor altamente extensible y vamos aprovechar esta posibilidad que nos ofrecen y construir un paquete que nos permita cubrir varios elementos (peticiones HTTP, SON, TDD, EMACS), el ejercicio entorna a implementar un módulo de EMACS que nos permita obtener el titulo de una incidencia, procediendo con:
Autenticar a Gitea Solicitar id de incidencia Consultar titulo de incidencia indicado E insertar titulo en el árbol del documento org."><link rel=icon href=http://bit4bit.github.io/favicon.ico><meta name=keywords content=" voip  freeswitch  Elixir  Crystal  Ruby  PHP "><meta property="og:title" content="Emacs - Básico 1 (TODO)"><meta property="og:description" content="GNU EMACS es un editor altamente extensible y vamos aprovechar esta posibilidad que nos ofrecen y construir un paquete que nos permita cubrir varios elementos (peticiones HTTP, SON, TDD, EMACS), el ejercicio entorna a implementar un módulo de EMACS que nos permita obtener el titulo de una incidencia, procediendo con:
Autenticar a Gitea Solicitar id de incidencia Consultar titulo de incidencia indicado E insertar titulo en el árbol del documento org."><meta property="og:type" content="article"><meta property="og:url" content="http://bit4bit.github.io/post/emacs_basics_1/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-07-09T21:54:27-05:00"><meta property="article:modified_time" content="2023-07-09T21:54:27-05:00"><link rel=canonical href=http://bit4bit.github.io/post/emacs_basics_1/><meta itemprop=name content="Emacs - Básico 1 (TODO)"><meta itemprop=description content="GNU EMACS es un editor altamente extensible y vamos aprovechar esta posibilidad que nos ofrecen y construir un paquete que nos permita cubrir varios elementos (peticiones HTTP, SON, TDD, EMACS), el ejercicio entorna a implementar un módulo de EMACS que nos permita obtener el titulo de una incidencia, procediendo con:
Autenticar a Gitea Solicitar id de incidencia Consultar titulo de incidencia indicado E insertar titulo en el árbol del documento org."><meta itemprop=datePublished content="2023-07-09T21:54:27-05:00"><meta itemprop=dateModified content="2023-07-09T21:54:27-05:00"><meta itemprop=wordCount content="3196"><meta itemprop=keywords content><link media=screen rel=stylesheet href=http://bit4bit.github.io/css/common.css><link media=screen rel=stylesheet href=http://bit4bit.github.io/css/content.css><title>Emacs - Básico 1 (TODO) - Bit4bit Integraciones</title><meta name=twitter:card content="summary"><meta name=twitter:title content="Emacs - Básico 1 (TODO)"><meta name=twitter:description content="GNU EMACS es un editor altamente extensible y vamos aprovechar esta posibilidad que nos ofrecen y construir un paquete que nos permita cubrir varios elementos (peticiones HTTP, SON, TDD, EMACS), el ejercicio entorna a implementar un módulo de EMACS que nos permita obtener el titulo de una incidencia, procediendo con:
Autenticar a Gitea Solicitar id de incidencia Consultar titulo de incidencia indicado E insertar titulo en el árbol del documento org."><link rel=stylesheet href=http://bit4bit.github.io/css/single.css></head><body><div id=wrapper><header id=header><h1><a href=http://bit4bit.github.io/>Bit4bit Integraciones</a></h1><nav><span class=nav-bar-item><a class=link href=/>Post</a></span>
<span class=nav-bar-item><a class=link href=/post/>Archives</a></span>
<span class=nav-bar-item><a class=link href=/about/>About</a></span></nav></header><main id=main class=post><h1>Emacs - Básico 1 (TODO)</h1><article class=content><p>GNU EMACS es un editor altamente extensible y vamos aprovechar esta posibilidad
que nos ofrecen y construir un paquete que nos permita cubrir
varios elementos (peticiones HTTP, SON, TDD, EMACS),
el ejercicio entorna a implementar un módulo de EMACS que nos permita obtener el titulo de una incidencia, procediendo con:</p><ul><li>Autenticar a Gitea</li><li>Solicitar id de incidencia</li><li>Consultar titulo de incidencia indicado</li><li>E insertar titulo en el árbol del documento org.</li></ul><p>importante antes de empezar:</p><ul><li>ser usuario de EMACS.</li><li>nociones en desarrollo de software.</li><li>nociones del lenguaje LISP o uno de sus dialectos.</li></ul><p>Vamos a usar el <a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Introduction.html>dialecto ELisp</a> de EMACS el cual iremos conociendo poco a poco en el transcurso de la implementación.</p><p>Empecemos por crear la estructura mínima del paquete.</p><p><strong>Makefile</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#900;font-weight:700>.PHONY</span><span style=font-weight:700>:</span> test
</span></span><span style=display:flex><span><span style=color:#900;font-weight:700>test</span><span style=font-weight:700>:</span>
</span></span><span style=display:flex><span>	emacs --batch -L . -L tests -l grieta-tests.el -f ert-run-tests-batch
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Cannot open load file: No such file or directory, grieta-tests.el
</span></span><span style=display:flex><span>make: *** [Makefile:3: test] Error 255
</span></span></code></pre></div><p>Empecemos a ilustrarnos a partir del error</p><p><code>Cannot open load file: No such file or directory, grieta-tests.el</code></p><p>no ubica el archivo <code>grieta-tests.el</code>, pero en que directorio?</p><ul><li>en el parametro <code>-L</code> le indicamos a <code>ENACS</code> donde ubicar archivos <code>Lisp</code>.</li><li>en el parametro <code>-l</code> le indicamos interpretar el archivo <code>Lisp</code>.</li><li>en el parametro <code>-f</code> le indicamos una función a ejecutar.</li></ul><p>En otras palabras le estamos indicando a EMACS que ejecuta la función <a href=https://www.gnu.org/software/emacs/manual/html_node/ert/Running-Tests-in-Batch-Mode.html>ert-run-tests-batch</a> además que interprete el archivo <code>grieta-tests.el</code> y que
posiblemente lo puede encontrar en el directorio <code>tests</code>.
.</p><p><strong>tests/grieta-tests.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>mkdir tests
</span></span><span style=display:flex><span>touch tests/grieta-tests.el
</span></span></code></pre></div><pre tabindex=0><code class=language-ssh data-lang=ssh>make test
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Running 0 tests (2023-07-10 21:29:29-0500, selector ‘t’)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Ran 0 tests, 0 results as expected, 0 unexpected (2023-07-10 21:29:29-0500, 0.000060 sec)
</span></span></code></pre></div><p>muy bien no mas errores por ahora, ahora vamos a proceder a iniciar con las pruebas
y por medio de estas iremos realizando la implementación. Para automatizar las pruebas
utilizaremos <a href=https://www.gnu.org/software/emacs/manual/html_node/ert/>ERT</a>.</p><p>Para empezar definimos como agrupar las pruebas:</p><ul><li><code>UNIT</code> funciones que solo varían su comportamiento según los argumentos.</li><li><code>INTEGRATION</code> funciones que varían su comportamiento según los argumentos u otros medios como variables globales o lecturas fuera del proceso (lectura disco, red, etc..).</li><li><code>ACCEPTANCE</code> los mismo criterios que <code>INTEGRATION</code> pero solo sobre las funciones publicadas es decir sobre las funciones que son accesible por el usuario u otros paquetes.</li><li><code>MANUAL</code> pruebas que se deben realizar manualmente ya que el contexto no se puede reproduccir en <code>ACCEPTANCE</code>.</li></ul><p><strong>tests/grieta-tests.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;el-mock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; UNIT</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; INTEGRATION</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; ACCEPTANCE</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; MANUAL</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta-tests</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Cannot open load file: No such file or directory, el-mock
</span></span><span style=display:flex><span>make: *** [Makefile:3: test] Error 255
</span></span></code></pre></div><p>Uumm ya hemos visto anteriormente este error, <code>el-mock</code> es una dependencia
que utilizaremos para verificar el comportamiento en las pruebas <code>INTEGRATION</code> y <code>ACCEPTANCE</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>curl -q https://raw.githubusercontent.com/rejeep/el-mock.el/master/el-mock.el --output tests/el-mock.el
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Running 0 tests (2023-07-10 21:46:25-0500, selector ‘t’)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Ran 0 tests, 0 results as expected, 0 unexpected (2023-07-10 21:46:25-0500, 0.000052 sec)
</span></span></code></pre></div><p>Excelente, ya no tenemos error al importar la dependencia <code>el-mock</code> con (<a href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Named-Features.html#index-require>require</a> &rsquo;el-mock).</p><p><strong>tests/grieta-tests.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;el-mock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; UNIT</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; INTEGRATION</span>
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-issue-check-url-path</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>mock</span> (<span style=color:teal>grieta--gitea-call</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;GET&#34;</span> <span style=color:#b84>&#34;/api/v1/repos/demo/grieta/issues/99&#34;</span>))
</span></span><span style=display:flex><span>   (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>99</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; ACCEPTANCE</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; MANUAL</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta-tests</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Test grieta-test-grieta--gitea-issue-check-url-path condition:
</span></span><span style=display:flex><span>    (void-function grieta--gitea-issue)
</span></span><span style=display:flex><span>   FAILED  1/1  grieta-test-grieta--gitea-issue-check-url-path (0.000067 sec)
</span></span></code></pre></div><p>Iniciar las pruebas desde <code>INTEGRATION</code> o <code>ACCEPTANCE</code> nos facilita tener una perspectiva más cercana a su uso y empezar con anterioridad el flujo de la implementación, hemos decido empezar por confirmar que la petición este en la estructura
esperada por la API de gitea.</p><p><code>(void-function grieta--gitea-issue)</code> lo vamos a ver cuando no logra llamar la función, en nuestro caso es por que no existe.</p><p><strong>tests/grieta-tests.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;el-mock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-issue</span> (<span style=color:teal>host</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; UNIT</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; INTEGRATION</span>
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-issue-check-url-path</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>mock</span> (<span style=color:teal>grieta--gitea-call</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;GET&#34;</span> <span style=color:#b84>&#34;/api/v1/repos/demo/grieta/issues/99&#34;</span>))
</span></span><span style=display:flex><span>   (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>99</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; ACCEPTANCE</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; MANUAL</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta-tests</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>    (mock-error not-called grieta--gitea-call)
</span></span><span style=display:flex><span>   FAILED  1/1  grieta-test-grieta--gitea-issue-check-url-path (0.000075 sec)
</span></span></code></pre></div><p><code>(mock-error not-called grieta--gitea-call)</code> nos indica que se esperaba que se invocará esa función pero no sucedió.</p><p><strong>tests/grieta-tests.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;el-mock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-call</span> (<span style=color:teal>host</span> <span style=color:#458;font-weight:700>method</span> <span style=color:teal>path</span>))
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-issue</span> (<span style=color:teal>host</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>)
</span></span><span style=display:flex><span>  (<span style=color:teal>grieta--gitea-call</span> <span style=color:teal>host</span> <span style=color:#b84>&#34;GET&#34;</span> (<span style=color:#900;font-weight:700>format</span> <span style=color:#b84>&#34;/api/v1/repos/%s/%s/issues/%d&#34;</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; UNIT</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; INTEGRATION</span>
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-issue-check-url-path</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>mock</span> (<span style=color:teal>grieta--gitea-call</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;GET&#34;</span> <span style=color:#b84>&#34;/api/v1/repos/demo/grieta/issues/99&#34;</span>))
</span></span><span style=display:flex><span>   (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>99</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; ACCEPTANCE</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; MANUAL</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta-tests</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Running 1 tests (2023-07-10 22:03:12-0500, selector ‘t’)
</span></span><span style=display:flex><span>   passed  1/1  grieta-test-grieta--gitea-issue-check-url-path (0.000062 sec)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Ran 1 tests, 1 results as expected, 0 unexpected (2023-07-10 22:03:12-0500, 0.000143 sec)
</span></span></code></pre></div><p>Muy bien hemos ajustado según lo ilustrado por la prueba, ahora juguemos un poco en<br>aclarar el código, las funciones que creamos <code>grieta--gitea-issue</code> y <code>grieta--gitea-call</code> están en las pruebas, movamos estas pruebas a su propio archivo.</p><p><strong>grieta.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-call</span> (<span style=color:teal>host</span> <span style=color:#458;font-weight:700>method</span> <span style=color:teal>path</span>))
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-issue</span> (<span style=color:teal>host</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>)
</span></span><span style=display:flex><span>  (<span style=color:teal>grieta--gitea-call</span> <span style=color:teal>host</span> <span style=color:#b84>&#34;GET&#34;</span> (<span style=color:#900;font-weight:700>format</span> <span style=color:#b84>&#34;/api/v1/repos/%s/%s/issues/%d&#34;</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; https://www.gnu.org/software/emacs/manual/html_node/elisp/Named-Features.html</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; `provide` es necesario para luego importar con `require`</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta</span>)
</span></span></code></pre></div><p><strong>tests/grieta-tests.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;el-mock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; UNIT</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; INTEGRATION</span>
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-issue-check-url-path</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>mock</span> (<span style=color:teal>grieta--gitea-call</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;GET&#34;</span> <span style=color:#b84>&#34;/api/v1/repos/demo/grieta/issues/99&#34;</span>))
</span></span><span style=display:flex><span>   (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>99</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; ACCEPTANCE</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; MANUAL</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta-tests</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Test grieta-test-grieta--gitea-issue-check-url-path condition:
</span></span><span style=display:flex><span>    (void-function grieta--gitea-issue)
</span></span><span style=display:flex><span>   FAILED  1/1  grieta-test-grieta--gitea-issue-check-url-path (0.000073 sec)
</span></span></code></pre></div><p><code>(void-function grieta--gitea-issue)</code> ya hemos lo hemos vistos anteriormente, no logra ubicar
la función y claro es debido a que movimos la función a otro archivo, debemos
importar el archivo.</p><p><strong>tests/grieta-tests.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;el-mock</span>)
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;grieta</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; UNIT</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; INTEGRATION</span>
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-issue-check-url-path</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>mock</span> (<span style=color:teal>grieta--gitea-call</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;GET&#34;</span> <span style=color:#b84>&#34;/api/v1/repos/demo/grieta/issues/99&#34;</span>))
</span></span><span style=display:flex><span>   (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>99</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; ACCEPTANCE</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; MANUAL</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta-tests</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><pre tabindex=0><code class=language-output data-lang=output>Running 1 tests (2023-07-10 22:08:57-0500, selector ‘t’)
   passed  1/1  grieta-test-grieta--gitea-issue-check-url-path (0.000060 sec)

Ran 1 tests, 1 results as expected, 0 unexpected (2023-07-10 22:08:57-0500, 0.000137 sec)
</code></pre><p>Muy bien volvimos a estar estables, ya que empezamos por validar la estructura
de la URL podemos continuar sobre el mismo tema de validar elementos
hacia la API externa, procedamos por ejemplo con traducir la respuesta JSON a
una estructura interna.</p><p><strong>tests/grieta-tests.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;el-mock</span>)
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;grieta</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; UNIT</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; INTEGRATION</span>
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-json-&gt;issues</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; respuesta simplificada</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>stub</span> <span style=color:teal>grieta--gitea-call</span> <span style=color:teal>=&gt;</span> <span style=color:#b84>&#34;{\&#34;id\&#34;: 1000, \&#34;number\&#34;: 1, \&#34;title\&#34;: \&#34;Test\&#34;}&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   (<span style=color:teal>should</span> (<span style=color:#900;font-weight:700>equal</span>
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#39;</span>(<span style=color:#099>1</span> <span style=color:#b84>&#34;Test&#34;</span>)
</span></span><span style=display:flex><span>            (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>1</span>)))))
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-issue-check-url-path</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>mock</span> (<span style=color:teal>grieta--gitea-call</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;GET&#34;</span> <span style=color:#b84>&#34;/api/v1/repos/demo/grieta/issues/99&#34;</span>))
</span></span><span style=display:flex><span>   (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>99</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; ACCEPTANCE</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; MANUAL</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta-tests</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Test grieta-test-grieta--gitea-json-&gt;issues condition:
</span></span><span style=display:flex><span>    (ert-test-failed
</span></span><span style=display:flex><span>     ((should
</span></span><span style=display:flex><span>       (equal &#39;...
</span></span><span style=display:flex><span>	(grieta--gitea-issue &#34;gitea.test.org&#34; &#34;demo&#34; &#34;grieta&#34; 1)))
</span></span><span style=display:flex><span>      :form
</span></span><span style=display:flex><span>      (equal
</span></span><span style=display:flex><span>       ((1 &#34;Test&#34;))
</span></span><span style=display:flex><span>       &#34;{\&#34;id\&#34;: 1000, \&#34;number\&#34;: 1, \&#34;title\&#34;: \&#34;Test\&#34;}&#34;)
</span></span><span style=display:flex><span>      :value nil :explanation
</span></span><span style=display:flex><span>      (different-types
</span></span><span style=display:flex><span>       ((1 &#34;Test&#34;))
</span></span><span style=display:flex><span>       &#34;{\&#34;id\&#34;: 1000, \&#34;number\&#34;: 1, \&#34;title\&#34;: \&#34;Test\&#34;}&#34;)))
</span></span><span style=display:flex><span>   FAILED  2/2  grieta-test-grieta--gitea-json-&gt;issues (0.000051 sec)
</span></span></code></pre></div><p>miremos solo una parte</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>      :form
</span></span><span style=display:flex><span>      (equal
</span></span><span style=display:flex><span>       ((1 &#34;Test&#34;))
</span></span><span style=display:flex><span>       &#34;{\&#34;id\&#34;: 1000, \&#34;number\&#34;: 1, \&#34;title\&#34;: \&#34;Test\&#34;}&#34;)
</span></span></code></pre></div><p>evidentemente los resultados no son iguales estamos retornando directamente
la respuesta de la API, procedamos a implementar el traductor.</p><p><strong>grieta.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-call</span> (<span style=color:teal>host</span> <span style=color:#458;font-weight:700>method</span> <span style=color:teal>path</span>))
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-issue</span> (<span style=color:teal>host</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>)
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let*</span> ((<span style=color:teal>response</span> (<span style=color:teal>grieta--gitea-call</span> <span style=color:teal>host</span> <span style=color:#b84>&#34;GET&#34;</span> (<span style=color:#900;font-weight:700>format</span> <span style=color:#b84>&#34;/api/v1/repos/%s/%s/issues/%d&#34;</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>))))
</span></span><span style=display:flex><span>    (<span style=font-weight:700>if</span> <span style=color:teal>response</span>
</span></span><span style=display:flex><span>        (<span style=font-weight:700>let</span> ((<span style=color:teal>remote-issue</span> (<span style=color:teal>json-parse-string</span> <span style=color:teal>response</span>)))
</span></span><span style=display:flex><span>          (<span style=color:#458;font-weight:700>list</span> (<span style=color:#900;font-weight:700>gethash</span> <span style=color:#b84>&#34;number&#34;</span> <span style=color:teal>remote-issue</span>)
</span></span><span style=display:flex><span>                (<span style=color:#900;font-weight:700>gethash</span> <span style=color:#b84>&#34;title&#34;</span> <span style=color:teal>remote-issue</span>)))
</span></span><span style=display:flex><span>      <span style=color:teal>nil</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; https://www.gnu.org/software/emacs/manual/html_node/elisp/Named-Features.html</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; `provide` es necesario para luego importar con `require`</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Running 2 tests (2023-07-10 22:35:19-0500, selector ‘t’)
</span></span><span style=display:flex><span>   passed  1/2  grieta-test-grieta--gitea-issue-check-url-path (0.000058 sec)
</span></span><span style=display:flex><span>   passed  2/2  grieta-test-grieta--gitea-json-&gt;issues (0.000062 sec)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Ran 2 tests, 2 results as expected, 0 unexpected (2023-07-10 22:35:19-0500, 0.000208 sec
</span></span></code></pre></div><p>Hemos logrado estar otra vez estables, pero en este caso adicionamos un <code>if</code>
lo cual nos invita que debemos verificar cual sera el comportamiento cuando no se obtenga
una respuesta desde el servidor.</p><p><strong>tests/grieta-tests.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;el-mock</span>)
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;grieta</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; UNIT</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; INTEGRATION</span>
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-json-&gt;issues-on-valid-data</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; respuesta simplificada</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>stub</span> <span style=color:teal>grieta--gitea-call</span> <span style=color:teal>=&gt;</span> <span style=color:#b84>&#34;{\&#34;id\&#34;: 1000, \&#34;number\&#34;: 1, \&#34;title\&#34;: \&#34;Test\&#34;}&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   (<span style=color:teal>should</span> (<span style=color:#900;font-weight:700>equal</span>
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#39;</span>(<span style=color:#099>1</span> <span style=color:#b84>&#34;Test&#34;</span>)
</span></span><span style=display:flex><span>            (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>1</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-json-&gt;issues-on-invalid-data</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>stub</span> <span style=color:teal>grieta--gitea-call</span> <span style=color:teal>=&gt;</span> <span style=color:teal>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   (<span style=color:teal>should</span> (<span style=color:#900;font-weight:700>equal</span>
</span></span><span style=display:flex><span>            <span style=color:teal>nil</span> <span style=color:#998;font-style:italic>; volveremos a revisar luego si esta valor nos lleva a tener que usar condicionales</span>
</span></span><span style=display:flex><span>            (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>1</span>)))))
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-issue-check-url-path</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>mock</span> (<span style=color:teal>grieta--gitea-call</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;GET&#34;</span> <span style=color:#b84>&#34;/api/v1/repos/demo/grieta/issues/99&#34;</span>))
</span></span><span style=display:flex><span>   (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>99</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; ACCEPTANCE</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; MANUAL</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta-tests</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Running 3 tests (2023-07-10 22:39:39-0500, selector ‘t’)
</span></span><span style=display:flex><span>   passed  1/3  grieta-test-grieta--gitea-issue-check-url-path (0.000064 sec)
</span></span><span style=display:flex><span>   passed  2/3  grieta-test-grieta--gitea-json-&gt;issues-on-invalid-data (0.000030 sec)
</span></span><span style=display:flex><span>   passed  3/3  grieta-test-grieta--gitea-json-&gt;issues-on-valid-data (0.000067 sec)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Ran 3 tests, 3 results as expected, 0 unexpected (2023-07-10 22:39:39-0500, 0.000269 sec)
</span></span></code></pre></div><p>Ya con las pruebas en curso pasemos a completar la implementación es decir hacer la petición HTTP.</p><p><strong>grieta.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-call</span> (<span style=color:teal>host</span> <span style=color:#458;font-weight:700>method</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let</span> ((<span style=color:teal>url-request-method</span> <span style=color:#458;font-weight:700>method</span>)
</span></span><span style=display:flex><span>        (<span style=color:teal>url-request-data</span> <span style=color:teal>path</span>))
</span></span><span style=display:flex><span>    (<span style=color:teal>with-current-buffer</span>
</span></span><span style=display:flex><span>        (<span style=color:teal>url-retrieve-synchronously</span> (<span style=color:teal>concat</span> <span style=color:#b84>&#34;https://&#34;</span> <span style=color:teal>host</span> <span style=color:teal>path</span>))
</span></span><span style=display:flex><span>      (<span style=color:teal>goto-char</span> (<span style=color:teal>point-min</span>))
</span></span><span style=display:flex><span>      (<span style=color:teal>search-forward-regexp</span> <span style=color:#b84>&#34;\n\n&#34;</span>)
</span></span><span style=display:flex><span>      (<span style=color:teal>buffer-substring</span> (<span style=color:teal>point</span>) (<span style=color:teal>point-max</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-issue</span> (<span style=color:teal>host</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>)
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let*</span> ((<span style=color:teal>response</span> (<span style=color:teal>grieta--gitea-call</span> <span style=color:teal>host</span> <span style=color:#b84>&#34;GET&#34;</span> (<span style=color:#900;font-weight:700>format</span> <span style=color:#b84>&#34;/api/v1/repos/%s/%s/issues/%d&#34;</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>))))
</span></span><span style=display:flex><span>    (<span style=font-weight:700>if</span> <span style=color:teal>response</span>
</span></span><span style=display:flex><span>        (<span style=font-weight:700>let</span> ((<span style=color:teal>remote-issue</span> (<span style=color:teal>json-parse-string</span> <span style=color:teal>response</span>)))
</span></span><span style=display:flex><span>          (<span style=color:#458;font-weight:700>list</span> (<span style=color:#900;font-weight:700>gethash</span> <span style=color:#b84>&#34;number&#34;</span> <span style=color:teal>remote-issue</span>)
</span></span><span style=display:flex><span>                (<span style=color:#900;font-weight:700>gethash</span> <span style=color:#b84>&#34;title&#34;</span> <span style=color:teal>remote-issue</span>)))
</span></span><span style=display:flex><span>      <span style=color:teal>nil</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; https://www.gnu.org/software/emacs/manual/html_node/elisp/Named-Features.html</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; `provide` es necesario para luego importar con `require`</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta</span>)
</span></span></code></pre></div><p>Verificamos manualmente que funcione la petición al servidor.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>emacs --batch -l grieta.el --eval<span style=font-weight:700>=</span><span style=color:#b84>&#39;(print (grieta--gitea-call &#34;gitea.demo.org&#34; &#34;GET&#34; &#34;/api/v1/repos/bit4bit/prueba/issues/1&#34;))&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&#34;{\&#34;errors\&#34;:null,\&#34;message\&#34;:\&#34;The target couldn&#39;t be found.\&#34;,\&#34;url\&#34;:\&#34;https://gitea.onecluster.org/api/swagger\&#34;}
</span></span><span style=display:flex><span>&#34;
</span></span></code></pre></div><p>uuum, consultemos a un repositorio público</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>emacs --batch -l grieta.el --eval<span style=font-weight:700>=</span><span style=color:#b84>&#39;(print (grieta--gitea-call &#34;gitea.onecluster.org&#34; &#34;GET&#34; &#34;/api/v1/repos/OneTeam/trytondo-analytic_operations/issues/1&#34;))&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&#34;{\&#34;id\&#34;:1846,\&#34;url\&#34;:\&#34;https://gitea.onecluster.org/api/v1/repos/OneTeam/trytondo-analytic_operations/issues/1\&#34;,\&#34;html_url\&#34;:\&#34;https://gitea.onecluster.org/OneTeam/trytondo-analytic_operations/issues/1\&#34;,\&#34;number\&#34;:1,\&#34;user\&#34;:{\&#34;id\&#34;:5,\&#34;login\&#34;:\&#34;Rodia\&#34;,\&#34;login_name\&#34;:\&#34;\&#34;,\&#34;full_name\&#34;:\&#34;\&#34;,\&#34;email\&#34;:\&#34;rodia@noreply.onecluster.org\&#34;,\&#34;avatar_url\&#34;:\&#34;https://gitea.onecluster.org/avatar/2bb02a97b20d83fd00f4e7e044e9c1ef\&#34;,\&#34;language\&#34;:\&#34;\&#34;,\&#34;is_admin\&#34;:false,\&#34;last_login\&#34;:\&#34;0001-01-01T00:00:00Z\&#34;,\&#34;created\&#34;:\&#34;2021-09-05T14:03:55-05:00\&#34;,\&#34;restricted\&#34;:false,\&#34;active\&#34;:false,\&#34;prohibit_login\&#34;:false,\&#34;location\&#34;:\&#34;\&#34;,\&#34;website\&#34;:\&#34;\&#34;,\&#34;description\&#34;:\&#34;\&#34;,\&#34;visibility\&#34;:\&#34;public\&#34;,\&#34;followers_count\&#34;:0,\&#34;following_count\&#34;:0,\&#34;starred_repos_count\&#34;:0,\&#34;username\&#34;:\&#34;Rodia\&#34;},\&#34;original_author\&#34;:\&#34;\&#34;,\&#34;original_author_id\&#34;:0,\&#34;title\&#34;:\&#34;AÃ±adir Centro de Costos en Encabezado a Facturas de Cliente y de Proveedor\&#34;,\&#34;body\&#34;:\&#34;\&#34;,\&#34;ref\&#34;:\&#34;\&#34;,\&#34;assets\&#34;:[],\&#34;labels\&#34;:[],\&#34;milestone\&#34;:null,\&#34;assignee\&#34;:null,\&#34;assignees\&#34;:null,\&#34;state\&#34;:\&#34;open\&#34;,\&#34;is_locked\&#34;:false,\&#34;comments\&#34;:0,\&#34;created_at\&#34;:\&#34;2023-07-01T00:01:50-05:00\&#34;,\&#34;updated_at\&#34;:\&#34;2023-07-01T00:01:50-05:00\&#34;,\&#34;closed_at\&#34;:null,\&#34;due_date\&#34;:null,\&#34;pull_request\&#34;:null,\&#34;repository\&#34;:{\&#34;id\&#34;:2134,\&#34;name\&#34;:\&#34;trytondo-analytic_operations\&#34;,\&#34;owner\&#34;:\&#34;OneTeam\&#34;,\&#34;full_name\&#34;:\&#34;OneTeam/trytondo-analytic_operations\&#34;}}
</span></span><span style=display:flex><span>&#34;
</span></span></code></pre></div><p>ajaa, investigando un poco sobre la API nos indica que para repositorios privados
ahi que enviar una Api Key, ya ilustrados sobre este escenario procedamos a implementarlo,
pero antes revisemos algunos caminos.</p><ol><li>crear otra función ejemplo <code>grieta--gitea-auth-call</code>.</li><li>usar una variable global o función que nos entregue el api-key.</li><li>adicionar otro parámetro a la función <code>grieta-gitea-call</code>.</li></ol><p>La primera ya que aunque puede ser la más &ldquo;sencilla&rdquo; tendríamos
redundancia en la lógica que a posterior nos afectaría el mantenimiento, entonces la descartamos.</p><p>Ahora valoremos la segunda, especulemos sobre una posible implementación</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#999>defvar</span> <span style=color:teal>grieta-gitea-api-key-call</span> <span style=color:teal>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-call</span> (<span style=color:teal>host</span> <span style=color:#458;font-weight:700>method</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let</span> ((<span style=color:teal>url-request-method</span> <span style=color:#458;font-weight:700>method</span>)
</span></span><span style=display:flex><span>        ((<span style=color:teal>url-request-data</span> <span style=color:teal>path</span>))
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        (<span style=font-weight:700>if</span> <span style=color:teal>grieta-gitea-api-key-call</span>
</span></span><span style=display:flex><span>            (<span style=color:teal>url-request-extra-headers</span>
</span></span><span style=display:flex><span>             <span style=color:#998;font-style:italic>;; acoplamiento</span>
</span></span><span style=display:flex><span>             (<span style=color:#458;font-weight:700>cons</span> <span style=color:#b84>&#34;Authorization&#34;</span>  (<span style=color:#458;font-weight:700>cons</span> <span style=color:#b84>&#34;token &#34;</span> <span style=color:teal>grieta-gitea-api-key-call</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (<span style=color:teal>with-current-buffer</span>
</span></span><span style=display:flex><span>      (<span style=color:teal>url-retrieve-synchronously</span> (<span style=color:teal>concat</span> <span style=color:#b84>&#34;https://&#34;</span> <span style=color:teal>host</span> <span style=color:teal>path</span>))
</span></span><span style=display:flex><span>    (<span style=color:teal>goto-char</span> (<span style=color:teal>point-min</span>))
</span></span><span style=display:flex><span>    (<span style=color:teal>search-forward-regexp</span> <span style=color:#b84>&#34;\n\n&#34;</span>)
</span></span><span style=display:flex><span>    (<span style=color:teal>buffer-substring</span> (<span style=color:teal>point</span>) (<span style=color:teal>point-max</span>)))))
</span></span></code></pre></div><p>al ejecutar las pruebas estas pasan, pero miremos algo, recordando lo siguiente:</p><ul><li><code>UNIT</code> funciones que solo varían su comportamiento según los argumentos.</li><li><code>INTEGRATION</code> funciones que varían su comportamiento según los argumentos u otros medios como variables globales o lecturas fuera del proceso (lectura disco, red, etc..).</li><li><code>ACCEPTANCE</code> los mismo criterios que <code>INTEGRATION</code> pero solo sobre las funciones publicadas es decir sobre las funciones que son accesible por el usuario u otros paquetes.</li><li><code>MANUAL</code> pruebas que se deben realizar manualmente.</li></ul><p>hasta ahora hemos realizado las pruebas en el grupo de <code>INTEGRATION</code> donde
hemos verificado la interacción (with-mock) con <code>grieta--gitea-call</code> por medio de un doble,
no nos hemos interesado en probar detalles de la función ya que esta es una pasarela un servicio
externo donde no tenemos mas lógica que la ejecución del servicio, pero ahora
la situación cambia ya que creamos una dependencia implícita (ya que solo leyendo la implementación podemos determinarla) a una variable que va ser
modificada por el usuario creando un acoplamiento de un mecanismo privado a un
mecanismo netamente publico, ahora si usáramos las nociones anteriores para agrupar
esta prueba evidentemente iría en el grupo de <code>ACCEPTANCE</code> ya que la variable
debe ser asignada por el usuario para que se autentique al servicio,
pero como sabemos esta función no es más que una pasarela un servicio externo
por lo tanto las pruebas irían en <code>MANUAL</code>, por lo cual nos contra decimos podríamos continuar pero seria forzar algo que claramente no encaja.</p><p>Ahora especulemos sobre adicionar un parámetro</p><p><strong>grieta.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-call</span> (<span style=color:teal>host</span> <span style=color:teal>api-key</span> <span style=color:#458;font-weight:700>method</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let</span> ((<span style=color:teal>url-request-method</span> <span style=color:#458;font-weight:700>method</span>)
</span></span><span style=display:flex><span>        (<span style=color:teal>url-request-data</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>        (<span style=color:teal>url-request-extra-headers</span>
</span></span><span style=display:flex><span>         (<span style=color:#458;font-weight:700>list</span> (<span style=color:#458;font-weight:700>cons</span> <span style=color:#b84>&#34;Authorization&#34;</span>  (<span style=color:teal>concat</span> <span style=color:#b84>&#34;token &#34;</span> <span style=color:teal>api-key</span>)))))
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        (<span style=color:teal>with-current-buffer</span>
</span></span><span style=display:flex><span>            (<span style=color:teal>url-retrieve-synchronously</span> (<span style=color:teal>concat</span> <span style=color:#b84>&#34;https://&#34;</span> <span style=color:teal>host</span> <span style=color:teal>path</span>))
</span></span><span style=display:flex><span>          (<span style=color:teal>goto-char</span> (<span style=color:teal>point-min</span>))
</span></span><span style=display:flex><span>          (<span style=color:teal>search-forward-regexp</span> <span style=color:#b84>&#34;\n\n&#34;</span>)
</span></span><span style=display:flex><span>          (<span style=color:teal>buffer-substring</span> (<span style=color:teal>point</span>) (<span style=color:teal>point-max</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-issue</span> (<span style=color:teal>host</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>)
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let*</span> ((<span style=color:teal>response</span> (<span style=color:teal>grieta--gitea-call</span> <span style=color:teal>host</span> <span style=color:#b84>&#34;GET&#34;</span> (<span style=color:#900;font-weight:700>format</span> <span style=color:#b84>&#34;/api/v1/repos/%s/%s/issues/%d&#34;</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>))))
</span></span><span style=display:flex><span>    (<span style=font-weight:700>if</span> <span style=color:teal>response</span>
</span></span><span style=display:flex><span>        (<span style=font-weight:700>let</span> ((<span style=color:teal>remote-issue</span> (<span style=color:teal>json-parse-string</span> <span style=color:teal>response</span>)))
</span></span><span style=display:flex><span>          (<span style=color:#458;font-weight:700>list</span> (<span style=color:#900;font-weight:700>gethash</span> <span style=color:#b84>&#34;number&#34;</span> <span style=color:teal>remote-issue</span>)
</span></span><span style=display:flex><span>                (<span style=color:#900;font-weight:700>gethash</span> <span style=color:#b84>&#34;title&#34;</span> <span style=color:teal>remote-issue</span>)))
</span></span><span style=display:flex><span>      <span style=color:teal>nil</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; https://www.gnu.org/software/emacs/manual/html_node/elisp/Named-Features.html</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; `provide` es necesario para luego importar con `require`</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta</span>)
</span></span></code></pre></div><p>al cambiar la firma de la función debemos actualizar todas las funciones dependientes <a href=https://refactoring.com/>Martin Fowler en Refactoring</a>
propone una metodología estructura de realizar esto, ya que es algo que estamos haciendo constantemente es de suma importancia aprender a
refactorizar estructuradamente para no tomar caminos mas &ldquo;rapidos&rdquo; que a largo plazo son perjudiciales, ahora si valoramos nuevamente donde
la ubicaríamos para las pruebas, estas irían en <code>INTEGRATION</code> ya que realiza lecturas
fuera de proceso, mirando un poco más de cerca la función, esta solo realiza actividades fuera de proceso osea
que si realizáramos pruebas tendríamos que usar dobles para simular el comportamiento de funciones como <code>url-retrieve-synchronously</code>
pero este tipo de pruebas seria falsas ya que no conocemos o participamos del ciclo de desarrollo de esas funciones, este tipo
de funciones serán verificadas en comportamientos de <code>ACCEPTANCE</code> o bien <code>MANUAL</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>emacs --batch -l grieta.el --eval<span style=font-weight:700>=</span><span style=color:#b84>&#39;(print (grieta--gitea-call &#34;gitea.demo.org&#34; &#34;oeuaeiaoi&#34; &#34;GET&#34; &#34;/api/v1/repos/bit4bit/prueba/issues/1&#34;))&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>&#34;{\&#34;id\&#34;:1861,\&#34;url\&#34;:\&#34;https://gitea.onecluster.org/api/v1/repos/bit4bit/prueba/issues/1\&#34;,\&#34;html_url\&#34;:\&#34;https://gitea.onecluster.org/bit4bit/prueba/issues/1\&#34;,\&#34;number\&#34;:1,\&#34;user\&#34;:{\&#34;id\&#34;:10,\&#34;login\&#34;:\&#34;bit4bit\&#34;,\&#34;login_name\&#34;:\&#34;\&#34;,\&#34;full_name\&#34;:\&#34;\&#34;,\&#34;email\&#34;:\&#34;bit4bit@noreply.onecluster.org\&#34;,\&#34;avatar_url\&#34;:\&#34;https://gitea.onecluster.org/avatar/5984dea48f59d0cbf32c81e80cc81525\&#34;,\&#34;language\&#34;:\&#34;\&#34;,\&#34;is_admin\&#34;:false,\&#34;last_login\&#34;:\&#34;0001-01-01T00:00:00Z\&#34;,\&#34;created\&#34;:\&#34;2021-11-24T14:59:21-05:00\&#34;,\&#34;restricted\&#34;:false,\&#34;active\&#34;:false,\&#34;prohibit_login\&#34;:false,\&#34;location\&#34;:\&#34;\&#34;,\&#34;website\&#34;:\&#34;\&#34;,\&#34;description\&#34;:\&#34;\&#34;,\&#34;visibility\&#34;:\&#34;private\&#34;,\&#34;followers_count\&#34;:0,\&#34;following_count\&#34;:0,\&#34;starred_repos_count\&#34;:0,\&#34;username\&#34;:\&#34;bit4bit\&#34;},\&#34;original_author\&#34;:\&#34;\&#34;,\&#34;original_author_id\&#34;:0,\&#34;title\&#34;:\&#34;prueba\&#34;,\&#34;body\&#34;:\&#34;\&#34;,\&#34;ref\&#34;:\&#34;\&#34;,\&#34;assets\&#34;:[],\&#34;labels\&#34;:[],\&#34;milestone\&#34;:null,\&#34;assignee\&#34;:null,\&#34;assignees\&#34;:null,\&#34;state\&#34;:\&#34;open\&#34;,\&#34;is_locked\&#34;:false,\&#34;comments\&#34;:0,\&#34;created_at\&#34;:\&#34;2023-07-07T13:57:25-05:00\&#34;,\&#34;updated_at\&#34;:\&#34;2023-07-08T10:07:39-05:00\&#34;,\&#34;closed_at\&#34;:null,\&#34;due_date\&#34;:null,\&#34;pull_request\&#34;:null,\&#34;repository\&#34;:{\&#34;id\&#34;:2098,\&#34;name\&#34;:\&#34;prueba\&#34;,\&#34;owner\&#34;:\&#34;bit4bit\&#34;,\&#34;full_name\&#34;:\&#34;bit4bit/prueba\&#34;}}
</span></span><span style=display:flex><span>&#34;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Running 3 tests (2023-07-14 20:36:23-0500, selector ‘t’)
</span></span><span style=display:flex><span>   passed  1/3  grieta-test-grieta--gitea-issue-check-url-path (0.000058 sec)
</span></span><span style=display:flex><span>   passed  2/3  grieta-test-grieta--gitea-json-&gt;issues-on-invalid-data (0.000029 sec)
</span></span><span style=display:flex><span>   passed  3/3  grieta-test-grieta--gitea-json-&gt;issues-on-valid-data (0.000061 sec)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Ran 3 tests, 3 results as expected, 0 unexpected (2023-07-14 20:36:23-0500, 0.000264 sec)
</span></span></code></pre></div><p>aaa pero que paso?? porque pasaron las pruebas si cambio la firma de la funcion?? esto es algo que
suele ocurre cuando usamos dobles, por algo se le llama dobles, no es el elemento origen, creo que esto
puede aclara un poco de porque se recomienda evitar los dobles sobre elementos que no sean implementados por el proyecto,
por ejemplo <code>url-request-method</code> tiene un ciclo de desarrollo diferente.</p><p>Ahora miremos un poco como podemos mitigar el efecto de los dobles</p><p><strong>grieta.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-call</span> (<span style=color:teal>host</span> <span style=color:teal>api-key</span> <span style=color:#458;font-weight:700>method</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let</span> ((<span style=color:teal>url-request-method</span> <span style=color:#458;font-weight:700>method</span>)
</span></span><span style=display:flex><span>        (<span style=color:teal>url-request-data</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>        (<span style=color:teal>url-request-extra-headers</span>
</span></span><span style=display:flex><span>         (<span style=color:#458;font-weight:700>list</span> (<span style=color:#458;font-weight:700>cons</span> <span style=color:#b84>&#34;Authorization&#34;</span>  (<span style=color:teal>concat</span> <span style=color:#b84>&#34;token &#34;</span> <span style=color:teal>api-key</span>)))))
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        (<span style=color:teal>with-current-buffer</span>
</span></span><span style=display:flex><span>            (<span style=color:teal>url-retrieve-synchronously</span> (<span style=color:teal>concat</span> <span style=color:#b84>&#34;https://&#34;</span> <span style=color:teal>host</span> <span style=color:teal>path</span>))
</span></span><span style=display:flex><span>          (<span style=color:teal>goto-char</span> (<span style=color:teal>point-min</span>))
</span></span><span style=display:flex><span>          (<span style=color:teal>search-forward-regexp</span> <span style=color:#b84>&#34;\n\n&#34;</span>)
</span></span><span style=display:flex><span>          (<span style=color:teal>buffer-substring</span> (<span style=color:teal>point</span>) (<span style=color:teal>point-max</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-issue</span> (<span style=color:teal>host</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>)
</span></span><span style=display:flex><span>  <span style=color:#998;font-style:italic>;; es una abstraccion sobre la comunicacion con gitea</span>
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let*</span> ((<span style=color:teal>response</span> (<span style=color:teal>grieta--gitea-call</span> <span style=color:teal>host</span> <span style=color:#b84>&#34;GET&#34;</span> (<span style=color:#900;font-weight:700>format</span> <span style=color:#b84>&#34;/api/v1/repos/%s/%s/issues/%d&#34;</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>))))
</span></span><span style=display:flex><span>    (<span style=font-weight:700>if</span> <span style=color:teal>response</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic>;; pero aca tenemos un mecanismo de implementacion</span>
</span></span><span style=display:flex><span>        (<span style=font-weight:700>let</span> ((<span style=color:teal>remote-issue</span> (<span style=color:teal>json-parse-string</span> <span style=color:teal>response</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#998;font-style:italic>;; nuevamente una abstraccion</span>
</span></span><span style=display:flex><span>          (<span style=color:#458;font-weight:700>list</span> (<span style=color:#900;font-weight:700>gethash</span> <span style=color:#b84>&#34;number&#34;</span> <span style=color:teal>remote-issue</span>)
</span></span><span style=display:flex><span>                (<span style=color:#900;font-weight:700>gethash</span> <span style=color:#b84>&#34;title&#34;</span> <span style=color:teal>remote-issue</span>)))
</span></span><span style=display:flex><span>      <span style=color:teal>nil</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; https://www.gnu.org/software/emacs/manual/html_node/elisp/Named-Features.html</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; `provide` es necesario para luego importar con `require`</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta</span>)
</span></span></code></pre></div><p>Revisando nuevamente la funcion <code>grieta--gitea-issue</code> se puede ver que ahí un brinco entre diferentes niveles de abstracción,
vamos a llevar esto a un solo nivel.</p><p><strong>grieta.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--url-auth-request</span> (<span style=color:#458;font-weight:700>method</span> <span style=color:teal>token</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let</span> ((<span style=color:teal>url-request-method</span> <span style=color:#458;font-weight:700>method</span>)
</span></span><span style=display:flex><span>        (<span style=color:teal>url-request-data</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>        (<span style=color:teal>url-request-extra-headers</span>
</span></span><span style=display:flex><span>         (<span style=color:#458;font-weight:700>list</span> (<span style=color:#458;font-weight:700>cons</span> <span style=color:#b84>&#34;Authorization&#34;</span>  (<span style=color:teal>concat</span> <span style=color:#b84>&#34;token &#34;</span> <span style=color:teal>token</span>)))))
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        (<span style=color:teal>with-current-buffer</span>
</span></span><span style=display:flex><span>            (<span style=color:teal>url-retrieve-synchronously</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>          (<span style=color:teal>goto-char</span> (<span style=color:teal>point-min</span>))
</span></span><span style=display:flex><span>          (<span style=color:teal>search-forward-regexp</span> <span style=color:#b84>&#34;\n\n&#34;</span>)
</span></span><span style=display:flex><span>          (<span style=color:teal>buffer-substring</span> (<span style=color:teal>point</span>) (<span style=color:teal>point-max</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-call</span> (<span style=color:teal>host</span> <span style=color:teal>api-key</span> <span style=color:#458;font-weight:700>method</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let</span> ((<span style=color:teal>response</span> (<span style=color:teal>grieta--url-auth-request</span> <span style=color:#458;font-weight:700>method</span> <span style=color:teal>api-key</span> (<span style=color:teal>concat</span> <span style=color:#b84>&#34;https://&#34;</span> <span style=color:teal>host</span> <span style=color:teal>path</span>))))
</span></span><span style=display:flex><span>    (<span style=font-weight:700>if</span> <span style=color:teal>response</span>
</span></span><span style=display:flex><span>        (<span style=color:teal>json-parse-string</span> <span style=color:teal>response</span>)
</span></span><span style=display:flex><span>      <span style=color:teal>nil</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-issue</span> (<span style=color:teal>host</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>)
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let*</span> ((<span style=color:teal>remote-issue</span> (<span style=color:teal>grieta--gitea-call</span> <span style=color:teal>host</span> <span style=color:#b84>&#34;GET&#34;</span> (<span style=color:#900;font-weight:700>format</span> <span style=color:#b84>&#34;/api/v1/repos/%s/%s/issues/%d&#34;</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>))))
</span></span><span style=display:flex><span>    (<span style=font-weight:700>if</span> <span style=color:teal>remote-issue</span>
</span></span><span style=display:flex><span>        (<span style=color:#458;font-weight:700>list</span> (<span style=color:#900;font-weight:700>gethash</span> <span style=color:#b84>&#34;number&#34;</span> <span style=color:teal>remote-issue</span>)
</span></span><span style=display:flex><span>              (<span style=color:#900;font-weight:700>gethash</span> <span style=color:#b84>&#34;title&#34;</span> <span style=color:teal>remote-issue</span>))
</span></span><span style=display:flex><span>    <span style=color:teal>nil</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; https://www.gnu.org/software/emacs/manual/html_node/elisp/Named-Features.html</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; `provide` es necesario para luego importar con `require`</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta</span>)
</span></span></code></pre></div><p>hemos aplanado los niveles de abstracción por ejemplo <code>grieta--gitea-issue</code> habla en términos de una petición al servicio
y <code>grieta--gitea-call</code> habla en términos más técnicos hacer petición HTTP y procesar JSON,
como movimos las responsabilidades debemos actualizar los dobles usados en las pruebas.</p><p><strong>tests/grieta-tests.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;el-mock</span>)
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;grieta</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; UNIT</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; INTEGRATION</span>
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-json-&gt;issues-on-valid-data</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; respuesta simplificada</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>stub</span> <span style=color:teal>grieta--url-auth-request</span> <span style=color:teal>=&gt;</span> <span style=color:#b84>&#34;{\&#34;id\&#34;: 1000, \&#34;number\&#34;: 1, \&#34;title\&#34;: \&#34;Test\&#34;}&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   (<span style=color:teal>should</span> (<span style=color:#900;font-weight:700>equal</span>
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#39;</span>(<span style=color:#099>1</span> <span style=color:#b84>&#34;Test&#34;</span>)
</span></span><span style=display:flex><span>            (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>1</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-json-&gt;issues-on-invalid-data</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>stub</span> <span style=color:teal>grieta--url-auth-request</span> <span style=color:teal>=&gt;</span> <span style=color:teal>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   (<span style=color:teal>should</span> (<span style=color:#900;font-weight:700>equal</span>
</span></span><span style=display:flex><span>            <span style=color:teal>nil</span> <span style=color:#998;font-style:italic>; volveremos a revisar luego si esta valor nos lleva a tener que usar condicionales</span>
</span></span><span style=display:flex><span>            (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>1</span>)))))
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-issue-check-url-path</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>mock</span> (<span style=color:teal>grieta--url-auth-request</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;GET&#34;</span> <span style=color:#b84>&#34;/api/v1/repos/demo/grieta/issues/99&#34;</span>))
</span></span><span style=display:flex><span>   (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>99</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; ACCEPTANCE</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; MANUAL</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta-tests</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Test grieta-test-grieta--gitea-json-&gt;issues-on-valid-data condition:
</span></span><span style=display:flex><span>    (wrong-number-of-arguments
</span></span><span style=display:flex><span>     (lambda
</span></span><span style=display:flex><span>       (host api-key method path)
</span></span><span style=display:flex><span>       (let
</span></span><span style=display:flex><span>	   ((response ...))
</span></span><span style=display:flex><span>	 (json-parse-string response)))
</span></span><span style=display:flex><span>     3)
</span></span><span style=display:flex><span>   FAILED  3/3  grieta-test-grieta--gitea-json-&gt;issues-on-valid-data (0.000073 sec)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Ran 3 tests, 0 results as expected, 3 unexpected (2023-07-14 21:01:44-0500, 0.114529 sec)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>3 unexpected results:
</span></span><span style=display:flex><span>   FAILED  grieta-test-grieta--gitea-issue-check-url-path
</span></span><span style=display:flex><span>   FAILED  grieta-test-grieta--gitea-json-&gt;issues-on-invalid-data
</span></span><span style=display:flex><span>   FAILED  grieta-test-grieta--gitea-json-&gt;issues-on-valid-data
</span></span></code></pre></div><p>Excelente ya se nos manifestó el error, procedamos a actualizar.</p><p><strong>grieta.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--url-auth-request</span> (<span style=color:#458;font-weight:700>method</span> <span style=color:teal>token</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let</span> ((<span style=color:teal>url-request-method</span> <span style=color:#458;font-weight:700>method</span>)
</span></span><span style=display:flex><span>        (<span style=color:teal>url-request-data</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>        (<span style=color:teal>url-request-extra-headers</span>
</span></span><span style=display:flex><span>         (<span style=color:#458;font-weight:700>list</span> (<span style=color:#458;font-weight:700>cons</span> <span style=color:#b84>&#34;Authorization&#34;</span>  (<span style=color:teal>concat</span> <span style=color:#b84>&#34;token &#34;</span> <span style=color:teal>token</span>)))))
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        (<span style=color:teal>with-current-buffer</span>
</span></span><span style=display:flex><span>            (<span style=color:teal>url-retrieve-synchronously</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>          (<span style=color:teal>goto-char</span> (<span style=color:teal>point-min</span>))
</span></span><span style=display:flex><span>          (<span style=color:teal>search-forward-regexp</span> <span style=color:#b84>&#34;\n\n&#34;</span>)
</span></span><span style=display:flex><span>          (<span style=color:teal>buffer-substring</span> (<span style=color:teal>point</span>) (<span style=color:teal>point-max</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-call</span> (<span style=color:teal>host</span> <span style=color:teal>api-key</span> <span style=color:#458;font-weight:700>method</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let</span> ((<span style=color:teal>response</span> (<span style=color:teal>grieta--url-auth-request</span> <span style=color:#458;font-weight:700>method</span> <span style=color:teal>api-key</span> (<span style=color:teal>concat</span> <span style=color:#b84>&#34;https://&#34;</span> <span style=color:teal>host</span> <span style=color:teal>path</span>))))
</span></span><span style=display:flex><span>    (<span style=font-weight:700>if</span> <span style=color:teal>response</span>
</span></span><span style=display:flex><span>        (<span style=color:teal>json-parse-string</span> <span style=color:teal>response</span>)
</span></span><span style=display:flex><span>      <span style=color:teal>nil</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-issue</span> (<span style=color:teal>host</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>)
</span></span><span style=display:flex><span>  <span style=color:#998;font-style:italic>;; TODO: api-key?</span>
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let*</span> ((<span style=color:teal>remote-issue</span> (<span style=color:teal>grieta--gitea-call</span> <span style=color:teal>host</span> <span style=color:teal>nil</span> <span style=color:#b84>&#34;GET&#34;</span> (<span style=color:#900;font-weight:700>format</span> <span style=color:#b84>&#34;/api/v1/repos/%s/%s/issues/%d&#34;</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>))))
</span></span><span style=display:flex><span>    (<span style=font-weight:700>if</span> <span style=color:teal>remote-issue</span>
</span></span><span style=display:flex><span>        (<span style=color:#458;font-weight:700>list</span> (<span style=color:#900;font-weight:700>gethash</span> <span style=color:#b84>&#34;number&#34;</span> <span style=color:teal>remote-issue</span>)
</span></span><span style=display:flex><span>              (<span style=color:#900;font-weight:700>gethash</span> <span style=color:#b84>&#34;title&#34;</span> <span style=color:teal>remote-issue</span>))
</span></span><span style=display:flex><span>      <span style=color:teal>nil</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; https://www.gnu.org/software/emacs/manual/html_node/elisp/Named-Features.html</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; `provide` es necesario para luego importar con `require`</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Test grieta-test-grieta--gitea-issue-check-url-path condition:
</span></span><span style=display:flex><span>    (mock-error
</span></span><span style=display:flex><span>     (grieta--url-auth-request &#34;gitea.test.org&#34; &#34;GET&#34; &#34;/api/v1/repos/demo/grieta/issues/99&#34;)
</span></span><span style=display:flex><span>     (grieta--url-auth-request &#34;GET&#34; nil &#34;https://gitea.test.org/api/v1/repos/demo/grieta/issues/99&#34;))
</span></span><span style=display:flex><span>   FAILED  1/3  grieta-test-grieta--gitea-issue-check-url-path (0.000096 sec)
</span></span><span style=display:flex><span>   passed  2/3  grieta-test-grieta--gitea-json-&gt;issues-on-invalid-data (0.000044 sec)
</span></span><span style=display:flex><span>   passed  3/3  grieta-test-grieta--gitea-json-&gt;issues-on-valid-data (0.000082 sec)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Ran 3 tests, 2 results as expected, 1 unexpected (2023-07-14 21:11:49-0500, 0.040699 sec)
</span></span></code></pre></div><p>excelente nos estamos ilustrando.</p><p><strong>tests/grieta-tests.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;el-mock</span>)
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;grieta</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; UNIT</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; INTEGRATION</span>
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-json-&gt;issues-on-valid-data</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; respuesta simplificada</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>stub</span> <span style=color:teal>grieta--url-auth-request</span> <span style=color:teal>=&gt;</span> <span style=color:#b84>&#34;{\&#34;id\&#34;: 1000, \&#34;number\&#34;: 1, \&#34;title\&#34;: \&#34;Test\&#34;}&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   (<span style=color:teal>should</span> (<span style=color:#900;font-weight:700>equal</span>
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#39;</span>(<span style=color:#099>1</span> <span style=color:#b84>&#34;Test&#34;</span>)
</span></span><span style=display:flex><span>            (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>1</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-json-&gt;issues-on-invalid-data</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>stub</span> <span style=color:teal>grieta--url-auth-request</span> <span style=color:teal>=&gt;</span> <span style=color:teal>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   (<span style=color:teal>should</span> (<span style=color:#900;font-weight:700>equal</span>
</span></span><span style=display:flex><span>            <span style=color:teal>nil</span> <span style=color:#998;font-style:italic>; volveremos a revisar luego si esta valor nos lleva a tener que usar condicionales</span>
</span></span><span style=display:flex><span>            (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>1</span>)))))
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-issue-check-url-path</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>mock</span> (<span style=color:teal>grieta--url-auth-request</span> <span style=color:#b84>&#34;GET&#34;</span> <span style=color:#b84>&#34;token&#34;</span> <span style=color:#b84>&#34;https://gitea.test.org/api/v1/repos/demo/grieta/issues/99&#34;</span>))
</span></span><span style=display:flex><span>   (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>99</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; ACCEPTANCE</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; MANUAL</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta-tests</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Test grieta-test-grieta--gitea-issue-check-url-path condition:
</span></span><span style=display:flex><span>    (mock-error
</span></span><span style=display:flex><span>     (grieta--url-auth-request &#34;GET&#34; &#34;token&#34; &#34;/api/v1/repos/demo/grieta/issues/99&#34;)
</span></span><span style=display:flex><span>     (grieta--url-auth-request &#34;GET&#34; nil &#34;https://gitea.test.org/api/v1/repos/demo/grieta/issues/99&#34;))
</span></span><span style=display:flex><span>   FAILED  1/3  grieta-test-grieta--gitea-issue-check-url-path (0.000098 sec)
</span></span><span style=display:flex><span>   passed  2/3  grieta-test-grieta--gitea-json-&gt;issues-on-invalid-data (0.000043 sec)
</span></span><span style=display:flex><span>   passed  3/3  grieta-test-grieta--gitea-json-&gt;issues-on-valid-data (0.000080 sec)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Ran 3 tests, 2 results as expected, 1 unexpected (2023-07-14 21:14:39-0500, 0.041251 sec)
</span></span></code></pre></div><p>las pruebas nos esta ilustrando, diciéndonos que piensa hacer con el token?
nuevamente tenemos varios caminos</p><ol><li>crear otra función ejemplo <code>grieta--gitea-auth-issue</code></li><li>usar una variable global o función que nos entregue el api-key.</li><li>adicionar otro parámetro a la función <code>grieta--gitea-issue</code>.</li></ol><p>ya conocemos las implicaciones de las dos primeras, vamonos directamente
por la tercera.</p><p><code>invito hacer el ejercio de llegar al estado presentado desde al archivo anteriomente expuesto a este, haciendo cambios que no dejen fallar las pruebas</code>
<strong>grieta.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--url-auth-request</span> (<span style=color:#458;font-weight:700>method</span> <span style=color:teal>token</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let</span> ((<span style=color:teal>url-request-method</span> <span style=color:#458;font-weight:700>method</span>)
</span></span><span style=display:flex><span>        (<span style=color:teal>url-request-data</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>        (<span style=color:teal>url-request-extra-headers</span>
</span></span><span style=display:flex><span>         (<span style=color:#458;font-weight:700>list</span> (<span style=color:#458;font-weight:700>cons</span> <span style=color:#b84>&#34;Authorization&#34;</span>  (<span style=color:teal>concat</span> <span style=color:#b84>&#34;token &#34;</span> <span style=color:teal>token</span>)))))
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        (<span style=color:teal>with-current-buffer</span>
</span></span><span style=display:flex><span>            (<span style=color:teal>url-retrieve-synchronously</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>          (<span style=color:teal>goto-char</span> (<span style=color:teal>point-min</span>))
</span></span><span style=display:flex><span>          (<span style=color:teal>search-forward-regexp</span> <span style=color:#b84>&#34;\n\n&#34;</span>)
</span></span><span style=display:flex><span>          (<span style=color:teal>buffer-substring</span> (<span style=color:teal>point</span>) (<span style=color:teal>point-max</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-call</span> (<span style=color:teal>host</span> <span style=color:teal>api-key</span> <span style=color:#458;font-weight:700>method</span> <span style=color:teal>path</span>)
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let</span> ((<span style=color:teal>response</span> (<span style=color:teal>grieta--url-auth-request</span> <span style=color:#458;font-weight:700>method</span> <span style=color:teal>api-key</span> (<span style=color:teal>concat</span> <span style=color:#b84>&#34;https://&#34;</span> <span style=color:teal>host</span> <span style=color:teal>path</span>))))
</span></span><span style=display:flex><span>    (<span style=font-weight:700>if</span> <span style=color:teal>response</span>
</span></span><span style=display:flex><span>        (<span style=color:teal>json-parse-string</span> <span style=color:teal>response</span>)
</span></span><span style=display:flex><span>      <span style=color:teal>nil</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#999>defun</span> <span style=color:teal>grieta--gitea-issue</span> (<span style=color:teal>host</span> <span style=color:teal>api-key</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>)
</span></span><span style=display:flex><span>  <span style=color:#998;font-style:italic>;; TODO: api-key?</span>
</span></span><span style=display:flex><span>  (<span style=font-weight:700>let*</span> ((<span style=color:teal>remote-issue</span> (<span style=color:teal>grieta--gitea-call</span> <span style=color:teal>host</span> <span style=color:teal>api-key</span> <span style=color:#b84>&#34;GET&#34;</span> (<span style=color:#900;font-weight:700>format</span> <span style=color:#b84>&#34;/api/v1/repos/%s/%s/issues/%d&#34;</span> <span style=color:teal>owner</span> <span style=color:teal>repo</span> <span style=color:teal>issue-id</span>))))
</span></span><span style=display:flex><span>    (<span style=font-weight:700>if</span> <span style=color:teal>remote-issue</span>
</span></span><span style=display:flex><span>        (<span style=color:#458;font-weight:700>list</span> (<span style=color:#900;font-weight:700>gethash</span> <span style=color:#b84>&#34;number&#34;</span> <span style=color:teal>remote-issue</span>)
</span></span><span style=display:flex><span>              (<span style=color:#900;font-weight:700>gethash</span> <span style=color:#b84>&#34;title&#34;</span> <span style=color:teal>remote-issue</span>))
</span></span><span style=display:flex><span>      <span style=color:teal>nil</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; https://www.gnu.org/software/emacs/manual/html_node/elisp/Named-Features.html</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; `provide` es necesario para luego importar con `require`</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta</span>)
</span></span></code></pre></div><p><strong>tests/grieta-tests.el</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lisp data-lang=lisp><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;el-mock</span>)
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>require</span> <span style=color:#b84>&#39;grieta</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; UNIT</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; INTEGRATION</span>
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-json-&gt;issues-on-valid-data</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; respuesta simplificada</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>stub</span> <span style=color:teal>grieta--url-auth-request</span> <span style=color:teal>=&gt;</span> <span style=color:#b84>&#34;{\&#34;id\&#34;: 1000, \&#34;number\&#34;: 1, \&#34;title\&#34;: \&#34;Test\&#34;}&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   (<span style=color:teal>should</span> (<span style=color:#900;font-weight:700>equal</span>
</span></span><span style=display:flex><span>            <span style=font-weight:700>&#39;</span>(<span style=color:#099>1</span> <span style=color:#b84>&#34;Test&#34;</span>)
</span></span><span style=display:flex><span>            (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;token&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>1</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-json-&gt;issues-on-invalid-data</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>stub</span> <span style=color:teal>grieta--url-auth-request</span> <span style=color:teal>=&gt;</span> <span style=color:teal>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   (<span style=color:teal>should</span> (<span style=color:#900;font-weight:700>equal</span>
</span></span><span style=display:flex><span>            <span style=color:teal>nil</span> <span style=color:#998;font-style:italic>; volveremos a revisar luego si esta valor nos lleva a tener que usar condicionales</span>
</span></span><span style=display:flex><span>            (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;token&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>1</span>)))))
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>(<span style=color:teal>ert-deftest</span> <span style=color:teal>grieta-test-grieta--gitea-issue-check-url-path</span> ()
</span></span><span style=display:flex><span>  (<span style=color:teal>with-mock</span>
</span></span><span style=display:flex><span>   <span style=color:#998;font-style:italic>;; https://try.gitea.io/api/swagger#/issue/issueGetIssue</span>
</span></span><span style=display:flex><span>   (<span style=color:teal>mock</span> (<span style=color:teal>grieta--url-auth-request</span> <span style=color:#b84>&#34;GET&#34;</span> <span style=color:#b84>&#34;token&#34;</span> <span style=color:#b84>&#34;https://gitea.test.org/api/v1/repos/demo/grieta/issues/99&#34;</span>))
</span></span><span style=display:flex><span>   (<span style=color:teal>grieta--gitea-issue</span> <span style=color:#b84>&#34;gitea.test.org&#34;</span> <span style=color:#b84>&#34;token&#34;</span> <span style=color:#b84>&#34;demo&#34;</span> <span style=color:#b84>&#34;grieta&#34;</span> <span style=color:#099>99</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; ACCEPTANCE</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>;; MANUAL</span>
</span></span><span style=display:flex><span>(<span style=color:#900;font-weight:700>provide</span> <span style=color:#b84>&#39;grieta-tests</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make <span style=color:#999>test</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Running 3 tests (2023-07-14 21:19:48-0500, selector ‘t’)
</span></span><span style=display:flex><span>   passed  1/3  grieta-test-grieta--gitea-issue-check-url-path (0.000064 sec)
</span></span><span style=display:flex><span>   passed  2/3  grieta-test-grieta--gitea-json-&gt;issues-on-invalid-data (0.000033 sec)
</span></span><span style=display:flex><span>   passed  3/3  grieta-test-grieta--gitea-json-&gt;issues-on-valid-data (0.000069 sec)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Ran 3 tests, 3 results as expected, 0 unexpected (2023-07-14 21:19:48-0500, 0.000305 sec)
</span></span></code></pre></div><p>boom, nuevamente estables este proceso que realizamos de:</p><ol><li>especular</li><li>ilustrar</li><li>ajustar (+ importante no olvidar limpiar y aclarar lo escrito)</li></ol><p>se realiza rápidamente en cuestión de segundos a minutos.</p><ul><li>TODO introduccion org</li><li>TODO inicializacion paquete</li><li>TODO inicializacion tdd</li><li>TODO implementacion</li><li>TODO publicacion paquete</li></ul></article><div class=paginator><a class=link href=http://bit4bit.github.io/post/freeswitch_integration_event2dial/>← prev</a>
<a class=link target=history href="https://chiselapp.com/user/bit4bit/repository/bit4bit_website/finfo?name=content/post%2femacs_basics_1.md">history</a>
<a class=link href="https://chiselapp.com/user/bit4bit/repository/bit4bit_website/raw?ci=tip&filename=content/post%2femacs_basics_1.md">source</a>
<a></a></div><div class=comment></div></main><footer id=footer><div><span>© 2019</span> - <span>2023</span></div><div><span>Powered by</span>
<a class=link href=https://gohugo.io/>Hugo</a>
<span>🍦 Theme</span>
<a class=link href=https://github.com/queensferryme/hugo-theme-texify>TeXify</a></div><div class=footnote><span>Follow me on <a class=link href=https://github.com/bit4bit>GitHub</a> or
<a class=link href=http://chiselapp.com/user/bit4bit/>Chiselapp</a> or
<a class=link href=/index.xml>RSS</a> |
<a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a><pre>fossil open https://chiselapp.com/user/bit4bit/repository/bit4bit_website --workdir website</pre></span></div></footer></div></body></html>