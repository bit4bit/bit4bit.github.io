<!doctype html><html lang=es-co><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=author content="Jovany Leandro G.C"><meta name=description content="Ahora el siguiente paso para personalizar trytond a nivel de código es la creación de modelos, para una solución efectiva al problema en desarrollo con el cliente es usar la comunicación entre modelos para expresar la solución, es decir la solución no esta en los modelos en si sino en la conversación entre estos, lo anterior es importante ternelo presente cuando modelamos ya que trytond sigue el patron Active Record el cual nos invita que el comportamiento debe estar junto a la data que lo contiene es decir, en vez de preguntarle a otro modelo por informacion lo que hacemos es decirle que hacer, cuando hablo de conversación entre modelos técnicamente seria la llamada de los métodos de los objetos representativos de los modelos, veamos un ejercicio un poco mas complejo que el presentado en Básico 1."><link rel=icon href=http://bit4bit.github.io/favicon.ico><meta name=keywords content=" voip  freeswitch  Elixir  Crystal  Ruby  PHP "><meta property="og:title" content="Escribiendo un Modulo de Tryton ERP Básico 2"><meta property="og:description" content="Ahora el siguiente paso para personalizar trytond a nivel de código es la creación de modelos, para una solución efectiva al problema en desarrollo con el cliente es usar la comunicación entre modelos para expresar la solución, es decir la solución no esta en los modelos en si sino en la conversación entre estos, lo anterior es importante ternelo presente cuando modelamos ya que trytond sigue el patron Active Record el cual nos invita que el comportamiento debe estar junto a la data que lo contiene es decir, en vez de preguntarle a otro modelo por informacion lo que hacemos es decirle que hacer, cuando hablo de conversación entre modelos técnicamente seria la llamada de los métodos de los objetos representativos de los modelos, veamos un ejercicio un poco mas complejo que el presentado en Básico 1."><meta property="og:type" content="article"><meta property="og:url" content="http://bit4bit.github.io/post/writing_module_trytond_basics_2/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-06-22T16:40:04-05:00"><meta property="article:modified_time" content="2023-06-22T16:40:04-05:00"><link rel=canonical href=http://bit4bit.github.io/post/writing_module_trytond_basics_2/><meta itemprop=name content="Escribiendo un Modulo de Tryton ERP Básico 2"><meta itemprop=description content="Ahora el siguiente paso para personalizar trytond a nivel de código es la creación de modelos, para una solución efectiva al problema en desarrollo con el cliente es usar la comunicación entre modelos para expresar la solución, es decir la solución no esta en los modelos en si sino en la conversación entre estos, lo anterior es importante ternelo presente cuando modelamos ya que trytond sigue el patron Active Record el cual nos invita que el comportamiento debe estar junto a la data que lo contiene es decir, en vez de preguntarle a otro modelo por informacion lo que hacemos es decirle que hacer, cuando hablo de conversación entre modelos técnicamente seria la llamada de los métodos de los objetos representativos de los modelos, veamos un ejercicio un poco mas complejo que el presentado en Básico 1."><meta itemprop=datePublished content="2023-06-22T16:40:04-05:00"><meta itemprop=dateModified content="2023-06-22T16:40:04-05:00"><meta itemprop=wordCount content="2522"><meta itemprop=keywords content><link media=screen rel=stylesheet href=http://bit4bit.github.io/css/common.css><link media=screen rel=stylesheet href=http://bit4bit.github.io/css/content.css><title>Escribiendo un Modulo de Tryton ERP Básico 2 - Bit4bit Integraciones</title><meta name=twitter:card content="summary"><meta name=twitter:title content="Escribiendo un Modulo de Tryton ERP Básico 2"><meta name=twitter:description content="Ahora el siguiente paso para personalizar trytond a nivel de código es la creación de modelos, para una solución efectiva al problema en desarrollo con el cliente es usar la comunicación entre modelos para expresar la solución, es decir la solución no esta en los modelos en si sino en la conversación entre estos, lo anterior es importante ternelo presente cuando modelamos ya que trytond sigue el patron Active Record el cual nos invita que el comportamiento debe estar junto a la data que lo contiene es decir, en vez de preguntarle a otro modelo por informacion lo que hacemos es decirle que hacer, cuando hablo de conversación entre modelos técnicamente seria la llamada de los métodos de los objetos representativos de los modelos, veamos un ejercicio un poco mas complejo que el presentado en Básico 1."><link rel=stylesheet href=http://bit4bit.github.io/css/single.css></head><body><div id=wrapper><header id=header><h1><a href=http://bit4bit.github.io/>Bit4bit Integraciones</a></h1><nav><span class=nav-bar-item><a class=link href=/>Post</a></span>
<span class=nav-bar-item><a class=link href=/post/>Archives</a></span>
<span class=nav-bar-item><a class=link href=/about/>About</a></span></nav></header><main id=main class=post><h1>Escribiendo un Modulo de Tryton ERP Básico 2</h1><article class=content><p>Ahora el siguiente paso para personalizar trytond a nivel de código es la creación de modelos,
para una solución efectiva al problema en desarrollo con el cliente
es usar la comunicación entre modelos para expresar la solución, es decir
la solución no esta en los modelos en si sino en la conversación entre estos,
lo anterior es importante ternelo presente cuando modelamos ya que trytond
sigue el patron <a href=https://martinfowler.com/eaaCatalog/activeRecord.html>Active Record</a> el
cual nos invita que el comportamiento debe estar junto a la data que lo contiene es decir,
en vez de preguntarle a otro <a href=https://www.martinfowler.com/bliki/TellDontAsk.html>modelo por informacion lo que hacemos es decirle que hacer</a>,
cuando hablo de conversación entre modelos técnicamente seria la llamada
de los métodos de los objetos representativos de los modelos, veamos un ejercicio un poco
mas complejo que el presentado en <strong>Básico 1</strong>.</p><p>Digamos que nuestro cliente vende minutos de telefonía y mensajes de texto SMS,
se encuentra con el inconveniente que no tiene una plataforma para llevar
control de la facturación y una vez se ha conversado sobre el asunto
se llega a la conclusión de que:</p><ul><li>Tryton ERP es el software adecuado</li><li>se debe vincular Tryton ERP a la plataforma de telefonía para llevar el control.</li></ul><p>En la siguiente conversación con el equipo de telefonía, nos comentan
que diariamente a las 00:00-05 suben el archivo a un servidor y nos podrían
dar acceso por medio de HTTP para descargar el archivo de nombre formateado <code>yyyy-mm-dd.csv</code></p><pre tabindex=0><code class=language-csv data-lang=csv>client_code,billsec,sms,day
AB123,1000,1,2023-06-22
CP535,2000,100,2023-06-22
</code></pre><p>Con la información anterior se plantean los siguientes escenarios con el cliente
para coordinar la entregar del proyecto:</p><ul><li>Como administrador debo ser capaz de asociar Party a un cliente de telefonía.</li><li>Como servicio autónomo concilio diariamente los saldos entregados por telefonía.</li></ul><h3 id=creamos-el-modulo>creamos el modulo</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>pip3 install <span style=color:teal>trytond</span><span style=font-weight:700>==</span>6.8.0 --user
</span></span><span style=display:flex><span>pip3 install proteus --user
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cookiecutter git+https://gitlab.com/bit4bit/cookiecutter-tryton-module.git --directory template --no-input <span style=color:teal>module_name</span><span style=font-weight:700>=</span>charging_tel <span style=color:teal>version</span><span style=font-weight:700>=</span>6.8.0 <span style=color:teal>test_with_scenario</span><span style=font-weight:700>=</span>charging_tel.rst
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#999>cd</span> charging_tel
</span></span><span style=display:flex><span>python3 setup.py develop --user
</span></span></code></pre></div><p>confirmamos que tengamos operatividad</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#999>cd</span> charging_tel
</span></span><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Ran 23 tests in 4.381s

OK
</pre><h4 id=escenario-como-administrador-debo-ser-capaz-de-asociar-party-a-un-cliente-de-telefonía>Escenario: Como administrador debo ser capaz de asociar Party a un cliente de telefonía.</h4><p><strong>tests/scenario_administrator_create_party_with_client_code.rst</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rst data-lang=rst><span style=display:flex><span><span style=color:#999>===================</span>
</span></span><span style=display:flex><span><span style=color:#999>Administrador Crear Party con campo client_code Scenario</span>
</span></span><span style=display:flex><span><span style=color:#999>===================</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span>Dependencias<span style=color:#b84>::</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b84>    &gt;&gt;&gt; from proteus import Model, Wizard</span>
</span></span><span style=display:flex><span><span style=color:#b84>    &gt;&gt;&gt; from trytond.tests.tools import activate_modules
</span></span></span><span style=display:flex><span><span style=color:#b84>
</span></span></span><span style=display:flex><span><span style=color:#b84></span>Activacion de modulos<span style=color:#b84>::</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b84>	&gt;&gt;&gt; config = activate_modules(&#39;charging_tel&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#b84>
</span></span></span><span style=display:flex><span><span style=color:#b84></span>Party con client_code::<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span>    &gt;&gt;&gt; Party = Model.get(&#39;party.party&#39;)<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span>	&gt;&gt;&gt; party = Party()<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span>    &gt;&gt;&gt; party.client_code = &#39;AB123&#39; # valor real uno de los entregados<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span>    &gt;&gt;&gt; party.save()<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span>    &gt;&gt;&gt; party.client_code<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span>    &#39;AB123&#39;<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Failed example:
    Party = Model.get('party.party')
	...
        return self._pool[self.database_name][type][name]
    KeyError: 'party.party'
</pre><p><code>KeyError: 'party.party'</code> ya conocemos que debemos hacer</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>pip3 install trytond-party<span style=font-weight:700>==</span>6.8.0 --user
</span></span></code></pre></div><p><strong>tryton.cfg</strong></p><pre tabindex=0><code class=language-config data-lang=config>[tryton]
version=6.8.0
depends:
    ir
    party
xml:
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Failed example:
    party.client_code = 'AB123' # valor real uno de los entregados
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.9/doctest.py", line 1336, in __run
        exec(compile(example.source, filename, "single",
      File "<doctest scenario_party_with_client_code.rst[5]>", line 1, in <module>
        party.client_code = 'AB123' # valor real uno de los entregados
    AttributeError: 'party.party' object has no attribute 'client_code'
</pre><p><code>AttributeError: 'party.party'</code> ya conocemos que debemos hacer</p><p><strong>party.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> PoolMeta
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model</span> <span style=font-weight:700>import</span> fields
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>Party</span>(metaclass<span style=font-weight:700>=</span>PoolMeta):
</span></span><span style=display:flex><span>    __name__ <span style=font-weight:700>=</span> <span style=color:#b84>&#39;party.party&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic># campo para relacionar party con el cliente de telefonia</span>
</span></span><span style=display:flex><span>    client_code <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Char(<span style=color:#b84>&#39;Client Code&#39;</span>, required<span style=font-weight:700>=</span><span style=font-weight:700>False</span>)
</span></span></code></pre></div><p>Le indicamos a trytond el modelo que hemos extendido</p><p><strong><strong>init</strong>.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> Pool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>.</span> <span style=font-weight:700>import</span> party
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>__all__ <span style=font-weight:700>=</span> [<span style=color:#b84>&#39;register&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>register</span>():
</span></span><span style=display:flex><span>    Pool<span style=font-weight:700>.</span>register(
</span></span><span style=display:flex><span>        party<span style=font-weight:700>.</span>Party,
</span></span><span style=display:flex><span>        module<span style=font-weight:700>=</span><span style=color:#b84>&#39;charging_tel&#39;</span>, type_<span style=font-weight:700>=</span><span style=color:#b84>&#39;model&#39;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Ran 24 tests in 8.997s

OK
</pre><p>por ahora dejare por fuera la gestión de permisos por usuario, ya
que los usuarios no administradores no deberían ser capaces de cambiar el campo
<code>client_code</code></p><h2 id=ahora-pasamos-a-verificar-que-el-client_code-sea-en-el-formato-esperado>ahora pasamos a verificar que el client_code sea en el formato esperado</h2><p><strong>tests/test_party_client_code.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.tests.test_tryton</span> <span style=font-weight:700>import</span> ModuleTestCase, with_transaction
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> Pool
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model.exceptions</span> <span style=font-weight:700>import</span> ValidationError
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>Party_client_code_TestCase</span>(ModuleTestCase):
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;Test Party client_code&#34;</span>
</span></span><span style=display:flex><span>    module <span style=font-weight:700>=</span> <span style=color:#b84>&#39;charging_tel&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @with_transaction()
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>test_para_entrada_invalida_hay_error</span>(self):
</span></span><span style=display:flex><span>        pool <span style=font-weight:700>=</span> Pool()
</span></span><span style=display:flex><span>        Party <span style=font-weight:700>=</span> pool<span style=font-weight:700>.</span>get(<span style=color:#b84>&#39;party.party&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        party, <span style=font-weight:700>=</span> Party<span style=font-weight:700>.</span>create([{<span style=color:#b84>&#39;name&#39;</span>: <span style=color:#b84>&#39;TEL&#39;</span>}])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(ValidationError):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>client_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;123546&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(ValidationError):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>client_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;3515ABC&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(ValidationError):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>client_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;_535&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(ValidationError):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>client_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;A535.&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @with_transaction()
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>test_para_entrada_valida_no_hay_error</span>(self):
</span></span><span style=display:flex><span>        pool <span style=font-weight:700>=</span> Pool()
</span></span><span style=display:flex><span>        Party <span style=font-weight:700>=</span> pool<span style=font-weight:700>.</span>get(<span style=color:#b84>&#39;party.party&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        party, <span style=font-weight:700>=</span> Party<span style=font-weight:700>.</span>create([{<span style=color:#b84>&#39;name&#39;</span>: <span style=color:#b84>&#39;TELO&#39;</span>}])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        party<span style=font-weight:700>.</span>client_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;AB123&#39;</span>
</span></span><span style=display:flex><span>        party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        party<span style=font-weight:700>.</span>client_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;CP535&#39;</span>
</span></span><span style=display:flex><span>        party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>del</span> ModuleTestCase
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Traceback (most recent call last):
  File "/home/bit4bit/.local/lib/python3.9/site-packages/trytond/tests/test_tryton.py", line 223, in wrapper
    result = func(*args, **kwargs)
  File "/tmp/d20230622-6588-e3ry82/charging_tel/tests/test_party_client_code.py", line 18, in test_para_entrada_invalida_UserError
    party.save()
AssertionError: ValidationError not raised
</pre><p><code>AssertionError: ValidationError not raised</code> ya conocemos como proceder</p><p><strong>party.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>re</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> PoolMeta
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model</span> <span style=font-weight:700>import</span> fields
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.i18n</span> <span style=font-weight:700>import</span> gettext
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model.exceptions</span> <span style=font-weight:700>import</span> ValidationError
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>Party</span>(metaclass<span style=font-weight:700>=</span>PoolMeta):
</span></span><span style=display:flex><span>    __name__ <span style=font-weight:700>=</span> <span style=color:#b84>&#39;party.party&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic># relacionamos party con cliente de telefonia</span>
</span></span><span style=display:flex><span>    client_code <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Char(<span style=color:#b84>&#39;Client Code&#39;</span>, required<span style=font-weight:700>=</span><span style=font-weight:700>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>validate_fields</span>(cls, records, field_names):
</span></span><span style=display:flex><span>        <span style=color:#999>super</span>()<span style=font-weight:700>.</span>validate_fields(records, field_names)
</span></span><span style=display:flex><span>        cls<span style=font-weight:700>.</span>check_fields(records, field_names)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>check_fields</span>(cls, records, field_names):
</span></span><span style=display:flex><span>        <span style=font-weight:700>if</span> field_names <span style=font-weight:700>and</span> <span style=font-weight:700>not</span> (field_names <span style=font-weight:700>&amp;</span> {<span style=color:#b84>&#39;client_code&#39;</span>}):
</span></span><span style=display:flex><span>            <span style=font-weight:700>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>for</span> record <span style=font-weight:700>in</span> records:
</span></span><span style=display:flex><span>            <span style=font-weight:700>if</span> <span style=font-weight:700>not</span> cls<span style=font-weight:700>.</span>is_allowed_client_code(record<span style=font-weight:700>.</span>client_code):
</span></span><span style=display:flex><span>                <span style=font-weight:700>raise</span> ValidationError(gettext(<span style=color:#b84>&#39;charging_tel.client_code_invalid&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>is_allowed_client_code</span>(cls, code):
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># opcional</span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>if</span> code <span style=font-weight:700>is</span> <span style=font-weight:700>None</span>:
</span></span><span style=display:flex><span>            <span style=font-weight:700>return</span> <span style=font-weight:700>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># formato entregado por area de telefonia</span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>return</span> <span style=color:#999>bool</span>(re<span style=font-weight:700>.</span><span style=font-weight:700>match</span>(<span style=color:#b84>r</span><span style=color:#b84>&#34;^[A-Z]{2,10}[0-9]{2,8}$&#34;</span>, code))
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Ran 47 tests in 11.937s

OK
</pre><p>a este punto nos preguntamos si <code>client_code</code> debe ser único por cliente,
lo cual es luego confirmado por el equipo técnico de telefonía,
entonces procedemos confirmar esta restricción.</p><p><strong>tests/test_party_client_code.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.tests.test_tryton</span> <span style=font-weight:700>import</span> ModuleTestCase, with_transaction
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> Pool
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model.exceptions</span> <span style=font-weight:700>import</span> ValidationError
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>Party_client_code_TestCase</span>(ModuleTestCase):
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;Test Party client_code&#34;</span>
</span></span><span style=display:flex><span>    module <span style=font-weight:700>=</span> <span style=color:#b84>&#39;charging_tel&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @with_transaction()
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>test_para_entrada_valida_debe_ser_unico</span>(self):
</span></span><span style=display:flex><span>        pool <span style=font-weight:700>=</span> Pool()
</span></span><span style=display:flex><span>        Party <span style=font-weight:700>=</span> pool<span style=font-weight:700>.</span>get(<span style=color:#b84>&#39;party.party&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        _, party <span style=font-weight:700>=</span> Party<span style=font-weight:700>.</span>create([{<span style=color:#b84>&#39;name&#39;</span>: <span style=color:#b84>&#39;TEL A&#39;</span>, <span style=color:#b84>&#39;client_code&#39;</span>: <span style=color:#b84>&#39;AB123&#39;</span>},
</span></span><span style=display:flex><span>                                 {<span style=color:#b84>&#39;name&#39;</span>: <span style=color:#b84>&#39;TEL B&#39;</span>}])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(<span style=color:#900;font-weight:700>Exception</span>):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>client_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;AB123&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @with_transaction()
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>test_para_entrada_invalida_hay_error</span>(self):
</span></span><span style=display:flex><span>        pool <span style=font-weight:700>=</span> Pool()
</span></span><span style=display:flex><span>        Party <span style=font-weight:700>=</span> pool<span style=font-weight:700>.</span>get(<span style=color:#b84>&#39;party.party&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        party, <span style=font-weight:700>=</span> Party<span style=font-weight:700>.</span>create([{<span style=color:#b84>&#39;name&#39;</span>: <span style=color:#b84>&#39;TEL&#39;</span>}])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(ValidationError):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>client_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;123546&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(ValidationError):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>client_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;3515ABC&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(ValidationError):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>client_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;_535&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(ValidationError):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>client_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;A535.&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @with_transaction()
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>test_para_entrada_valida_no_hay_error</span>(self):
</span></span><span style=display:flex><span>        pool <span style=font-weight:700>=</span> Pool()
</span></span><span style=display:flex><span>        Party <span style=font-weight:700>=</span> pool<span style=font-weight:700>.</span>get(<span style=color:#b84>&#39;party.party&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        party, <span style=font-weight:700>=</span> Party<span style=font-weight:700>.</span>create([{<span style=color:#b84>&#39;name&#39;</span>: <span style=color:#b84>&#39;TELO&#39;</span>}])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        party<span style=font-weight:700>.</span>client_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;AB123&#39;</span>
</span></span><span style=display:flex><span>        party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        party<span style=font-weight:700>.</span>client_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;CP535&#39;</span>
</span></span><span style=display:flex><span>        party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>del</span> ModuleTestCase
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Traceback (most recent call last):
  File "/home/bit4bit/.local/lib/python3.9/site-packages/trytond/tests/test_tryton.py", line 223, in wrapper
    result = func(*args, **kwargs)
  File "/tmp/d20230622-7701-1wybgva/charging_tel/tests/test_party_client_code.py", line 99, in test_para_entrada_valida_debe_ser_unico
    party.save()
AssertionError: Exception not raised
</pre><p>aja ya sabemos que hacer ;)</p><p><strong>party.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>re</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> PoolMeta
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model</span> <span style=font-weight:700>import</span> (Unique, fields)
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.i18n</span> <span style=font-weight:700>import</span> gettext
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model.exceptions</span> <span style=font-weight:700>import</span> ValidationError
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>Party</span>(metaclass<span style=font-weight:700>=</span>PoolMeta):
</span></span><span style=display:flex><span>    __name__ <span style=font-weight:700>=</span> <span style=color:#b84>&#39;party.party&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic># relacionamos party con cliente de telefonia</span>
</span></span><span style=display:flex><span>    client_code <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Char(<span style=color:#b84>&#39;Client Code&#39;</span>, required<span style=font-weight:700>=</span><span style=font-weight:700>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>__setup__</span>(cls):
</span></span><span style=display:flex><span>        <span style=color:#999>super</span>()<span style=font-weight:700>.</span>__setup__()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># ver https://docs.tryton.org/projects/server/en/latest/ref/models.html#trytond.model.ModelSQL._sql_constraints</span>
</span></span><span style=display:flex><span>        t <span style=font-weight:700>=</span> cls<span style=font-weight:700>.</span>__table__()
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># hacemos efectiva la restriccion desde base de datos</span>
</span></span><span style=display:flex><span>        cls<span style=font-weight:700>.</span>_sql_constraints <span style=font-weight:700>+=</span> [
</span></span><span style=display:flex><span>            (<span style=color:#b84>&#39;client_code_unique&#39;</span>, Unique(t, t<span style=font-weight:700>.</span>client_code),
</span></span><span style=display:flex><span>             <span style=color:#b84>&#39;charging_tel.msg_client_code_unique&#39;</span>)
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>validate_fields</span>(cls, records, field_names):
</span></span><span style=display:flex><span>        <span style=color:#999>super</span>()<span style=font-weight:700>.</span>validate_fields(records, field_names)
</span></span><span style=display:flex><span>        cls<span style=font-weight:700>.</span>check_fields(records, field_names)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>check_fields</span>(cls, records, field_names):
</span></span><span style=display:flex><span>        <span style=font-weight:700>if</span> field_names <span style=font-weight:700>and</span> <span style=font-weight:700>not</span> (field_names <span style=font-weight:700>&amp;</span> {<span style=color:#b84>&#39;client_code&#39;</span>}):
</span></span><span style=display:flex><span>            <span style=font-weight:700>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>for</span> record <span style=font-weight:700>in</span> records:
</span></span><span style=display:flex><span>            <span style=font-weight:700>if</span> <span style=font-weight:700>not</span> cls<span style=font-weight:700>.</span>is_allowed_client_code(record<span style=font-weight:700>.</span>client_code):
</span></span><span style=display:flex><span>                <span style=font-weight:700>raise</span> ValidationError(gettext(<span style=color:#b84>&#39;charging_tel.client_code_invalid&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>is_allowed_client_code</span>(cls, code):
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># opcional</span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>if</span> code <span style=font-weight:700>is</span> <span style=font-weight:700>None</span>:
</span></span><span style=display:flex><span>            <span style=font-weight:700>return</span> <span style=font-weight:700>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># formato entregado por area de telefonia</span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>return</span> <span style=color:#999>bool</span>(re<span style=font-weight:700>.</span><span style=font-weight:700>match</span>(<span style=color:#b84>r</span><span style=color:#b84>&#34;^[A-Z]{2,10}[0-9]{2,8}$&#34;</span>, code))
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Ran 49 tests in 12.318s

OK
</pre><h4 id=escenario-como-servicio-autónomo-concilio-diariamente-los-saldos-entregados-por-telefonía>Escenario: Como servicio autónomo concilio diariamente los saldos entregados por telefonía.</h4><p><strong>tests/scenario_create_recharge_tel.rst</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rst data-lang=rst><span style=display:flex><span><span style=color:#999>===================</span>
</span></span><span style=display:flex><span><span style=color:#999>Crear Cargo de Telefonia</span>
</span></span><span style=display:flex><span><span style=color:#999>===================</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span>Dependencias<span style=color:#b84>::</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b84>    &gt;&gt;&gt; from proteus import Model, Wizard</span>
</span></span><span style=display:flex><span><span style=color:#b84>    &gt;&gt;&gt; from trytond.tests.tools import activate_modules
</span></span></span><span style=display:flex><span><span style=color:#b84>
</span></span></span><span style=display:flex><span><span style=color:#b84></span>Activacion de modulos<span style=color:#b84>::</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b84>    &gt;&gt;&gt; config = activate_modules(&#39;charging_tel&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#b84>
</span></span></span><span style=display:flex><span><span style=color:#b84></span>Crear cargo de telefonia:<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span>    &gt;&gt;&gt; example_csv = open(&#39;tests/tel_2023-06-23.csv&#39;).read().encode()<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span>    &gt;&gt;&gt; ChargeTel = Model.get(&#39;charging_tel.charge_tel&#39;)<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span>	&gt;&gt;&gt; ChargeTel.import_csv(example_csv)<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span>	&gt;&gt;&gt; len(ChargeTel.find())<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span>	2<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Failed example:
    example_csv = open('tests/tel_2023-06-23.csv').read().encode()
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.9/doctest.py", line 1336, in __run
        exec(compile(example.source, filename, "single",
      File "<doctest scenario_create_charge_tel.rst[3]>", line 1, in <module>
        example_csv = open('tests/tel_2023-06-23.csv').read().encode()
    FileNotFoundError: [Errno 2] No such file or directory: 'tests/tel_2023-06-23.csv'
</pre><p>Efectivamente nos informa que no tenemos el archivo de muestra, vamos a crearlo</p><p><strong>tests/tel_2023-06-23.csv</strong></p><pre tabindex=0><code class=language-csv data-lang=csv>client_code,billsec,sms,day
ABC123,1000,1,2023-06-22
CP535,2000,100,2023-06-22
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Failed example:
    ChargeTel = Model.get('charging_tel.charge_tel')
	...
		return self._pool[self.database_name][type][name]
    KeyError: 'charging_tel.charge_tel'

</pre><p>Aja, ya vamos volviéndonos hábiles en esto, ya sabemos que debemos hacer y es crear el modelo,
para esto debemos indicarle a trytond que nuestro modelo va a gestionar <a href=https://docs.tryton.org/projects/server/en/latest/tutorial/module/model.html>datos extendiendo la clase de <code>ModelSQL</code></a>
y que a su vez <a href=https://docs.tryton.org/projects/server/en/latest/tutorial/module/view.html>va ser visible al usuario <code>ModelView</code></a> adicionalmente le indicamos
cuales son los <a href=https://docs.tryton.org/projects/server/en/latest/ref/fields.html#field>campos</a> que vamos a gestionar.</p><p><strong>charge_tel.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model</span> <span style=font-weight:700>import</span> ModelView, ModelSQL, fields
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># le indicamos a trytond que nuestra modelo va a gestionar datos `ModelSQL`</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># y va ha ser presentable desde la interfaz `ModelView`</span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>ChargeTel</span>(ModelSQL, ModelView):
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;Charge Tel&#34;</span>
</span></span><span style=display:flex><span>    __name__ <span style=font-weight:700>=</span> <span style=color:#b84>&#39;charging_tel.charge_tel&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic># habilitamos `readonly` para indicar que no puede ser editado luego de creado</span>
</span></span><span style=display:flex><span>    client_code <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Char(<span style=color:#b84>&#39;Client Code&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    billsec <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Integer(<span style=color:#b84>&#39;Billsec&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    sms <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Integer(<span style=color:#b84>&#39;SMS&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    day <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Date(<span style=color:#b84>&#39;DAY&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span></code></pre></div><p><strong><strong>init</strong>.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> Pool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>.</span> <span style=font-weight:700>import</span> party
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>.</span> <span style=font-weight:700>import</span> charge_tel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>__all__ <span style=font-weight:700>=</span> [<span style=color:#b84>&#39;register&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>register</span>():
</span></span><span style=display:flex><span>    Pool<span style=font-weight:700>.</span>register(
</span></span><span style=display:flex><span>        party<span style=font-weight:700>.</span>Party,
</span></span><span style=display:flex><span>        charge_tel<span style=font-weight:700>.</span>ChargeTel,
</span></span><span style=display:flex><span>        module<span style=font-weight:700>=</span><span style=color:#b84>&#39;charging_tel&#39;</span>, type_<span style=font-weight:700>=</span><span style=color:#b84>&#39;model&#39;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Failed example:
    ChargeTel.import_csv(example_csv)
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.9/doctest.py", line 1336, in __run
        exec(compile(example.source, filename, "single",
      File "<doctest scenario_create_charge_tel.rst[5]>", line 1, in <module>
        ChargeTel.import_csv(example_csv)
    AttributeError: type object 'charging_tel.charge_tel' has no attribute 'import_csv'
</pre><p><strong>charge_tel.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model</span> <span style=font-weight:700>import</span> ModelView, ModelSQL, fields
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>ChargeTel</span>(ModelSQL, ModelView):
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;Charge Tel&#34;</span>
</span></span><span style=display:flex><span>    __name__ <span style=font-weight:700>=</span> <span style=color:#b84>&#39;charging_tel.charge_tel&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic># habilitamos `readonly` para indicar que no puede ser editado luego de creado</span>
</span></span><span style=display:flex><span>    client_code <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Char(<span style=color:#b84>&#39;Client Code&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    billsec <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Integer(<span style=color:#b84>&#39;Billsec&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    sms <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Integer(<span style=color:#b84>&#39;SMS&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    day <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Date(<span style=color:#b84>&#39;DAY&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>import_csv</span>(cls, path):
</span></span><span style=display:flex><span>        <span style=font-weight:700>pass</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Failed example:
    ChargeTel.import_csv(example_csv)
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.9/doctest.py", line 1336, in __run
        exec(compile(example.source, filename, "single",
      File "<doctest scenario_create_charge_tel.rst[5]>", line 1, in <module>
        ChargeTel.import_csv(example_csv)
    AttributeError: type object 'charging_tel.charge_tel' has no attribute 'import_csv'
</pre><p>uuu nos indica que el modelo no tiene el atributo <code>import_csv</code>, que en nuestro caso
esperamos sea el método de importación, podríamos hacer accesible este método a proteus usando el mecanismo <strong>RPC</strong> de trytond pero en nuestro caso publicaríamos
este método solo con el objetivo de realizar la prueba, estas situaciones
es un indicio que el camino que hemos tomado no es el mas adecuado sea que
la prueba que planteamos es confusa o bien el mecanismo para probar no es el mas adecuado,
vamos a trasladar la prueba como prueba de unidad.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>rm -f tests/scenario_create_charge_tel.rst
</span></span></code></pre></div><p><strong>tests/test_create_charge_tel.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>datetime</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.tests.test_tryton</span> <span style=font-weight:700>import</span> ModuleTestCase, with_transaction
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> Pool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>CreateChargeTel</span>(ModuleTestCase):
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;Test Create Charge Tel&#34;</span>
</span></span><span style=display:flex><span>    module <span style=font-weight:700>=</span> <span style=color:#b84>&#39;charging_tel&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @with_transaction()
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>test_crear_cargos_desde_csv</span>(self):
</span></span><span style=display:flex><span>        pool <span style=font-weight:700>=</span> Pool()
</span></span><span style=display:flex><span>        ChargeTel <span style=font-weight:700>=</span> pool<span style=font-weight:700>.</span>get(<span style=color:#b84>&#39;charging_tel.charge_tel&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ChargeTel<span style=font-weight:700>.</span>import_csv(<span style=color:#b84>&#39;tests/tel_2023-06-23.csv&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        charges <span style=font-weight:700>=</span> ChargeTel<span style=font-weight:700>.</span>search([])
</span></span><span style=display:flex><span>        got <span style=font-weight:700>=</span> [{<span style=color:#b84>&#39;client_code&#39;</span>: c<span style=font-weight:700>.</span>client_code,
</span></span><span style=display:flex><span>                          <span style=color:#b84>&#39;billsec&#39;</span>: c<span style=font-weight:700>.</span>billsec,
</span></span><span style=display:flex><span>                          <span style=color:#b84>&#39;sms&#39;</span>: c<span style=font-weight:700>.</span>sms,
</span></span><span style=display:flex><span>                          <span style=color:#b84>&#39;day&#39;</span>: c<span style=font-weight:700>.</span>day} <span style=font-weight:700>for</span> c <span style=font-weight:700>in</span> charges]
</span></span><span style=display:flex><span>        self<span style=font-weight:700>.</span>assertListEqual([
</span></span><span style=display:flex><span>            {<span style=color:#b84>&#39;client_code&#39;</span>: <span style=color:#b84>&#39;ABC123&#39;</span>,
</span></span><span style=display:flex><span>             <span style=color:#b84>&#39;billsec&#39;</span>: <span style=color:#099>1000</span>,
</span></span><span style=display:flex><span>             <span style=color:#b84>&#39;sms&#39;</span>: <span style=color:#099>1</span>,
</span></span><span style=display:flex><span>             <span style=color:#b84>&#39;day&#39;</span>: datetime<span style=font-weight:700>.</span>date(<span style=color:#099>2023</span>, <span style=color:#099>6</span>, <span style=color:#099>22</span>)},
</span></span><span style=display:flex><span>            {<span style=color:#b84>&#39;client_code&#39;</span>: <span style=color:#b84>&#39;CP535&#39;</span>,
</span></span><span style=display:flex><span>             <span style=color:#b84>&#39;billsec&#39;</span>: <span style=color:#099>2000</span>,
</span></span><span style=display:flex><span>             <span style=color:#b84>&#39;sms&#39;</span>: <span style=color:#099>100</span>,
</span></span><span style=display:flex><span>             <span style=color:#b84>&#39;day&#39;</span>: datetime<span style=font-weight:700>.</span>date(<span style=color:#099>2023</span>, <span style=color:#099>6</span>, <span style=color:#099>22</span>)}
</span></span><span style=display:flex><span>        ], got)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>del</span> ModuleTestCase
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Traceback (most recent call last):
  File "/home/bit4bit/.local/lib/python3.9/site-packages/trytond/tests/test_tryton.py", line 223, in wrapper
    result = func(*args, **kwargs)
  File "/tmp/d20230623-7356-1tmqcx4/charging_tel/tests/test_create_charge_tel.py", line 16, in test_crear_cargos_desde_csv
    self.assertEqual(len(charges), 2)
AssertionError: 0 != 2

----------------------------------------------------------------------
Ran 72 tests in 15.397s

FAILED (failures=1, errors=1)
</pre><p>excelente ya nos reconoció el método <code>import_csv</code> y ya con la prueba ilustrando nos,
procedemos a realizar los ajustes sobre el método <code>import_csv</code>.</p><p><strong>charge_tel.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>csv</span>
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model</span> <span style=font-weight:700>import</span> ModelView, ModelSQL, fields
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>ChargeTel</span>(ModelSQL, ModelView):
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;Charge Tel&#34;</span>
</span></span><span style=display:flex><span>    __name__ <span style=font-weight:700>=</span> <span style=color:#b84>&#39;charging_tel.charge_tel&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic># habilitamos `readonly` para indicar que no puede ser editado luego de creado</span>
</span></span><span style=display:flex><span>    client_code <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Char(<span style=color:#b84>&#39;Client Code&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    billsec <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Integer(<span style=color:#b84>&#39;Billsec&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    sms <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Integer(<span style=color:#b84>&#39;SMS&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    day <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Date(<span style=color:#b84>&#39;DAY&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>import_csv</span>(cls, path):
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># https://docs.python.org/3/library/csv.html</span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> <span style=color:#999>open</span>(path, newline<span style=font-weight:700>=</span><span style=color:#b84>&#39;&#39;</span>) <span style=font-weight:700>as</span> csvfile:
</span></span><span style=display:flex><span>            reader <span style=font-weight:700>=</span> <span style=color:#999>list</span>(csv<span style=font-weight:700>.</span>DictReader(csvfile))
</span></span><span style=display:flex><span>            <span style=font-weight:700>return</span> cls<span style=font-weight:700>.</span>create(reader)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Ran 72 tests in 15.477s

OK
</pre><p>muy bien, ya tenemos el metodo que nos importaría desde csv los cargos de telefonía</p><p>ahora vamos a proceder a obtener el archivo desde el endpoint entregado por telefonía.</p><p><strong>tests/test_import_remote_charge_tel.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>datetime</span>
</span></span><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>unittest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.tests.test_tryton</span> <span style=font-weight:700>import</span> ModuleTestCase, with_transaction
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> Pool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>ImportFromRemoteChargeTel</span>(ModuleTestCase):
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;Import from remote endpoint Charge Tel&#34;</span>
</span></span><span style=display:flex><span>    module <span style=font-weight:700>=</span> <span style=color:#b84>&#39;charging_tel&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @with_transaction()
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>test_importar_cargos_desde_servicio_remote</span>(self):
</span></span><span style=display:flex><span>        pool <span style=font-weight:700>=</span> Pool()
</span></span><span style=display:flex><span>        ChargeTel <span style=font-weight:700>=</span> pool<span style=font-weight:700>.</span>get(<span style=color:#b84>&#39;charging_tel.charge_tel&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># sustituimos el metodo de descarga por una version</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># ajustada para las pruebas, evitamos las acciones sobre</span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># el servicio remoto</span>
</span></span><span style=display:flex><span>        ChargeTel<span style=font-weight:700>.</span>_downloader <span style=font-weight:700>=</span> self<span style=font-weight:700>.</span>_fake_downloader
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ChargeTel<span style=font-weight:700>.</span>import_remote()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        charges <span style=font-weight:700>=</span> ChargeTel<span style=font-weight:700>.</span>search([])
</span></span><span style=display:flex><span>        got <span style=font-weight:700>=</span> [{<span style=color:#b84>&#39;client_code&#39;</span>: c<span style=font-weight:700>.</span>client_code,
</span></span><span style=display:flex><span>                          <span style=color:#b84>&#39;billsec&#39;</span>: c<span style=font-weight:700>.</span>billsec,
</span></span><span style=display:flex><span>                          <span style=color:#b84>&#39;sms&#39;</span>: c<span style=font-weight:700>.</span>sms,
</span></span><span style=display:flex><span>                          <span style=color:#b84>&#39;day&#39;</span>: c<span style=font-weight:700>.</span>day} <span style=font-weight:700>for</span> c <span style=font-weight:700>in</span> charges]
</span></span><span style=display:flex><span>        self<span style=font-weight:700>.</span>assertListEqual([
</span></span><span style=display:flex><span>            {<span style=color:#b84>&#39;client_code&#39;</span>: <span style=color:#b84>&#39;ABC123&#39;</span>,
</span></span><span style=display:flex><span>             <span style=color:#b84>&#39;billsec&#39;</span>: <span style=color:#099>1000</span>,
</span></span><span style=display:flex><span>             <span style=color:#b84>&#39;sms&#39;</span>: <span style=color:#099>1</span>,
</span></span><span style=display:flex><span>             <span style=color:#b84>&#39;day&#39;</span>: datetime<span style=font-weight:700>.</span>date(<span style=color:#099>2023</span>, <span style=color:#099>6</span>, <span style=color:#099>22</span>)},
</span></span><span style=display:flex><span>            {<span style=color:#b84>&#39;client_code&#39;</span>: <span style=color:#b84>&#39;CP535&#39;</span>,
</span></span><span style=display:flex><span>             <span style=color:#b84>&#39;billsec&#39;</span>: <span style=color:#099>2000</span>,
</span></span><span style=display:flex><span>             <span style=color:#b84>&#39;sms&#39;</span>: <span style=color:#099>100</span>,
</span></span><span style=display:flex><span>             <span style=color:#b84>&#39;day&#39;</span>: datetime<span style=font-weight:700>.</span>date(<span style=color:#099>2023</span>, <span style=color:#099>6</span>, <span style=color:#099>22</span>)}
</span></span><span style=display:flex><span>        ], got)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>_fake_downloader</span>(self, year, month, day):
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> <span style=color:#999>open</span>(<span style=color:#b84>&#39;tests/tel_2023-06-23.csv&#39;</span>) <span style=font-weight:700>as</span> f:
</span></span><span style=display:flex><span>            <span style=font-weight:700>return</span> f<span style=font-weight:700>.</span>read()<span style=font-weight:700>.</span>encode()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>del</span> ModuleTestCase    
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Traceback (most recent call last):
  File "/home/bit4bit/.local/lib/python3.9/site-packages/trytond/tests/test_tryton.py", line 223, in wrapper
    result = func(*args, **kwargs)
  File "/tmp/d20230623-35869-15s1jvk/charging_tel/tests/test_import_remote_charge_tel.py", line 16, in test_importar_cargos_desde_servicio_remote
    ChargeTel.import_remote(downloader=self._fake_downloader)
AttributeError: type object 'charging_tel.charge_tel' has no attribute 'import_remote'
</pre><p>Tal cual, ya vamos conociendo el ciclo de: especular, ilustrar y ajustar :).</p><p><strong>charge_tel.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>csv</span>
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model</span> <span style=font-weight:700>import</span> ModelView, ModelSQL, fields
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>ChargeTel</span>(ModelSQL, ModelView):
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;Charge Tel&#34;</span>
</span></span><span style=display:flex><span>    __name__ <span style=font-weight:700>=</span> <span style=color:#b84>&#39;charging_tel.charge_tel&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic># habilitamos `readonly` para indicar que no puede ser editado luego de creado</span>
</span></span><span style=display:flex><span>    client_code <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Char(<span style=color:#b84>&#39;Client Code&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    billsec <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Integer(<span style=color:#b84>&#39;Billsec&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    sms <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Integer(<span style=color:#b84>&#39;SMS&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    day <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Date(<span style=color:#b84>&#39;DAY&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>import_csv</span>(cls, path):
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># https://docs.python.org/3/library/csv.html</span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> <span style=color:#999>open</span>(path, newline<span style=font-weight:700>=</span><span style=color:#b84>&#39;&#39;</span>) <span style=font-weight:700>as</span> csvfile:
</span></span><span style=display:flex><span>            reader <span style=font-weight:700>=</span> <span style=color:#999>list</span>(csv<span style=font-weight:700>.</span>DictReader(csvfile))
</span></span><span style=display:flex><span>            <span style=font-weight:700>return</span> cls<span style=font-weight:700>.</span>create(reader)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>import_remote</span>(cls, downloader<span style=font-weight:700>=</span><span style=font-weight:700>None</span>):
</span></span><span style=display:flex><span>        <span style=font-weight:700>if</span> downloader <span style=font-weight:700>is</span> <span style=font-weight:700>None</span>:
</span></span><span style=display:flex><span>            downloader <span style=font-weight:700>=</span> cls<span style=font-weight:700>.</span>_downloader
</span></span><span style=display:flex><span>        <span style=font-weight:700>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>_downloader</span>(cls):
</span></span><span style=display:flex><span>        <span style=font-weight:700>pass</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
First list contains 2 additional elements.
First extra element 0:
{'client_code': 'ABC123', 'billsec': 1000, 'sms': 1, 'day': datetime.date(2023, 6, 22)}

+ []
- [{'billsec': 1000,
-   'client_code': 'ABC123',
-   'day': datetime.date(2023, 6, 22),
-   'sms': 1},
-  {'billsec': 2000,
-   'client_code': 'CP535',
-   'day': datetime.date(2023, 6, 22),
-   'sms': 100}]
</pre><p>Excelente, ya no tenemos errores por parte Python, ahora la prueba nos
indica que no coinciden los valores, pasemos a ajustar la implementación es
decir vamos a sustituir los <code>pass</code> por nuestra primera versión de código ejecutable.</p><p><strong>charge_tel.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>csv</span>
</span></span><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>tempfile</span>
</span></span><span style=display:flex><span><span style=font-weight:700>import</span> <span style=color:#555>urllib.request</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model</span> <span style=font-weight:700>import</span> ModelView, ModelSQL, fields
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> Pool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>ChargeTel</span>(ModelSQL, ModelView):
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;Charge Tel&#34;</span>
</span></span><span style=display:flex><span>    __name__ <span style=font-weight:700>=</span> <span style=color:#b84>&#39;charging_tel.charge_tel&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic># habilitamos `readonly` para indicar que no puede ser editado luego de creado</span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic># si esto es un requerimiento por parte del cliente, debemos realizar</span>
</span></span><span style=display:flex><span>    <span style=color:#998;font-style:italic># una prueba para garantizar este comportamiento.</span>
</span></span><span style=display:flex><span>	<span style=color:#998;font-style:italic># TODO: como procedemos si la codificacion es incorrecta a la entregada?</span>
</span></span><span style=display:flex><span>    client_code <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Char(<span style=color:#b84>&#39;Client Code&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    billsec <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Integer(<span style=color:#b84>&#39;Billsec&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    sms <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Integer(<span style=color:#b84>&#39;SMS&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>    day <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Date(<span style=color:#b84>&#39;DAY&#39;</span>, readonly<span style=font-weight:700>=</span><span style=font-weight:700>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>import_csv</span>(cls, path):
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># https://docs.python.org/3/library/csv.html</span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> <span style=color:#999>open</span>(path, newline<span style=font-weight:700>=</span><span style=color:#b84>&#39;&#39;</span>) <span style=font-weight:700>as</span> csvfile:
</span></span><span style=display:flex><span>            reader <span style=font-weight:700>=</span> <span style=color:#999>list</span>(csv<span style=font-weight:700>.</span>DictReader(csvfile))
</span></span><span style=display:flex><span>            <span style=font-weight:700>return</span> cls<span style=font-weight:700>.</span>create(reader)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>import_remote</span>(cls, downloader<span style=font-weight:700>=</span><span style=font-weight:700>None</span>):
</span></span><span style=display:flex><span>        pool <span style=font-weight:700>=</span> Pool()
</span></span><span style=display:flex><span>        Date <span style=font-weight:700>=</span> pool<span style=font-weight:700>.</span>get(<span style=color:#b84>&#39;ir.date&#39;</span>)
</span></span><span style=display:flex><span>        today <span style=font-weight:700>=</span> Date<span style=font-weight:700>.</span>today()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        content <span style=font-weight:700>=</span> cls<span style=font-weight:700>.</span>_downloader(year<span style=font-weight:700>=</span>today<span style=font-weight:700>.</span>year,
</span></span><span style=display:flex><span>                                  month<span style=font-weight:700>=</span>today<span style=font-weight:700>.</span>month,
</span></span><span style=display:flex><span>                                  day<span style=font-weight:700>=</span>today<span style=font-weight:700>.</span>day)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> tempfile<span style=font-weight:700>.</span>NamedTemporaryFile(prefix<span style=font-weight:700>=</span><span style=color:#b84>&#39;charge-tel&#39;</span>) <span style=font-weight:700>as</span> f:
</span></span><span style=display:flex><span>            f<span style=font-weight:700>.</span>write(content)
</span></span><span style=display:flex><span>            f<span style=font-weight:700>.</span>flush()
</span></span><span style=display:flex><span>            cls<span style=font-weight:700>.</span>import_csv(f<span style=font-weight:700>.</span>name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>_downloader</span>(cls, year, month, day):
</span></span><span style=display:flex><span>        <span style=font-weight:700>return</span> urllib<span style=font-weight:700>.</span>request<span style=font-weight:700>.</span>urlopen(<span style=color:#b84>f</span><span style=color:#b84>&#34;http://example.com/</span><span style=color:#b84>{</span>year<span style=color:#b84>}</span><span style=color:#b84>-</span><span style=color:#b84>{</span>month<span style=color:#b84>}</span><span style=color:#b84>-</span><span style=color:#b84>{</span>day<span style=color:#b84>}</span><span style=color:#b84>.csv&#34;</span>)<span style=font-weight:700>.</span>read()
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Ran 95 tests in 0.579s

OK
</pre><p>uii yuiyuii, volvimos a estar estable y ya mas cerca de cerrar este escenario,
ahora para hacer la importación diaria podemos usar <a href=https://docs.tryton.org/projects/server/en/latest/topics/cron.html>Cron</a> de trytond que nos facilita
programar acciones.</p><p><strong>cron.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> PoolMeta
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>ChargeTelCron</span>(metaclass<span style=font-weight:700>=</span>PoolMeta):
</span></span><span style=display:flex><span>    __name__ <span style=font-weight:700>=</span> <span style=color:#b84>&#39;ir.cron&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>__setup__</span>(cls):
</span></span><span style=display:flex><span>        <span style=color:#999>super</span>()<span style=font-weight:700>.</span>__setup__()
</span></span><span style=display:flex><span>        cls<span style=font-weight:700>.</span>method<span style=font-weight:700>.</span>selection<span style=font-weight:700>.</span>append(
</span></span><span style=display:flex><span>            (<span style=color:#b84>&#39;charging_tel.charge_tel|import_remote&#39;</span>, <span style=color:#b84>&#34;Import Charges From Remote Server&#34;</span>),
</span></span><span style=display:flex><span>            )
</span></span></code></pre></div><p>e informamos a trytond</p><p><strong><strong>init</strong>.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> Pool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>.</span> <span style=font-weight:700>import</span> party
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>.</span> <span style=font-weight:700>import</span> charge_tel
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>.</span> <span style=font-weight:700>import</span> cron
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>__all__ <span style=font-weight:700>=</span> [<span style=color:#b84>&#39;register&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>register</span>():
</span></span><span style=display:flex><span>    Pool<span style=font-weight:700>.</span>register(
</span></span><span style=display:flex><span>        party<span style=font-weight:700>.</span>Party,
</span></span><span style=display:flex><span>        charge_tel<span style=font-weight:700>.</span>ChargeTel,
</span></span><span style=display:flex><span>        cron<span style=font-weight:700>.</span>ChargeTelCron,
</span></span><span style=display:flex><span>        module<span style=font-weight:700>=</span><span style=color:#b84>&#39;charging_tel&#39;</span>, type_<span style=font-weight:700>=</span><span style=color:#b84>&#39;model&#39;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Ran 95 tests in 0.585s

OK
</pre><p>muy bien todo sigue operativa y ademas ya hemos indicado a trytond nuestra
intención de poder registrar un Cron para importar los registros del servidor remoto.</p><p>Con la ultima implementación daríamos por cerrado los escenarios planteados
con el cliente donde ademas quedamos con una suite de pruebas para garantizar lo acordado y documentación de como el software participa de los objetivos del cliente.</p><p>Por ultimo dejo como ejercicio al lector la implementación de las vistas.</p><ul><li>creación del módulo usando la plantilla</li><li>escribir el módulo usando el un ciclo de: especular, ilustrar y ajustar</li><li>plantear los escenarios aceptables acordados con el cliente en <strong>doctest</strong></li><li>informar a trytond nuestra intención por medio de <strong>tryton.cfg</strong> y <strong><strong>init</strong>.py</strong></li><li>extender modelo usando <em>PoolMeta</em></li><li>crear nuevo modelo usando <em>ModelSQL</em> y <em>ModelView</em></li></ul><p>si deseas generar el proyecto creado en este post u otro post, puede usar <a href=/post/mdtoapp>mdtoapp</a></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:teal>ARTIFACT</span><span style=font-weight:700>=</span><span style=color:#099>1</span> <span style=color:teal>TO</span><span style=font-weight:700>=</span>/tmp/basico-2 ruby mdtoapp.rb <span style=color:#b84>&#39;https://chiselapp.com/user/bit4bit/repository/bit4bit_website/raw?ci=tip&amp;filename=content/post%2fwriting_module_trytond_basics_2.md&#39;</span>
</span></span></code></pre></div></article><div class=paginator><a class=link href=http://bit4bit.github.io/post/writing_module_trytond_basics_1/>← prev</a>
<a class=link target=history href="https://chiselapp.com/user/bit4bit/repository/bit4bit_website/finfo?name=content/post%2fwriting_module_trytond_basics_2.md">history</a>
<a class=link href="https://chiselapp.com/user/bit4bit/repository/bit4bit_website/raw?ci=tip&filename=content/post%2fwriting_module_trytond_basics_2.md">source</a>
<a></a></div><div class=comment></div></main><footer id=footer><div><span>© 2019</span> - <span>2023</span></div><div><span>Powered by</span>
<a class=link href=https://gohugo.io/>Hugo</a>
<span>🍦 Theme</span>
<a class=link href=https://github.com/queensferryme/hugo-theme-texify>TeXify</a></div><div class=footnote><span>Follow me on <a class=link href=https://github.com/bit4bit>GitHub</a> or
<a class=link href=http://chiselapp.com/user/bit4bit/>Chiselapp</a> or
<a class=link href=/index.xml>RSS</a> |
<a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a><pre>fossil open https://chiselapp.com/user/bit4bit/repository/bit4bit_website --workdir website</pre></span></div></footer></div></body></html>