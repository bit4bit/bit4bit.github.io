<!doctype html><html lang=es-co><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=author content="Jovany Leandro G.C"><meta name=description content="Tryton ERP es un excelente framework y mas su versatilidad a la hora de personalizar o bien escribir m√≥dulos, a continuaci√≥n estudiaremos un poco como extender el comportamiento y la vista de los m√≥dulos el que considero como el primer paso para aprender a personalizar a trytond a nivel de codigo, asumo que se tiene conocimiento de Python, Tryton ERP y desarrollo de software en general.
Nuestra primera tarea es extender el modulo party y adicionar el campo CIIU."><link rel=icon href=http://bit4bit.github.io/favicon.ico><meta name=keywords content=" voip  freeswitch  Elixir  Crystal  Ruby  PHP "><meta property="og:title" content="Escribiendo un Modulo de Tryton ERP Fundamentos 1"><meta property="og:description" content="Tryton ERP es un excelente framework y mas su versatilidad a la hora de personalizar o bien escribir m√≥dulos, a continuaci√≥n estudiaremos un poco como extender el comportamiento y la vista de los m√≥dulos el que considero como el primer paso para aprender a personalizar a trytond a nivel de codigo, asumo que se tiene conocimiento de Python, Tryton ERP y desarrollo de software en general.
Nuestra primera tarea es extender el modulo party y adicionar el campo CIIU."><meta property="og:type" content="article"><meta property="og:url" content="http://bit4bit.github.io/post/writing_module_trytond_basics_1/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-06-20T16:47:56-05:00"><meta property="article:modified_time" content="2023-06-20T16:47:56-05:00"><link rel=canonical href=http://bit4bit.github.io/post/writing_module_trytond_basics_1/><meta itemprop=name content="Escribiendo un Modulo de Tryton ERP Fundamentos 1"><meta itemprop=description content="Tryton ERP es un excelente framework y mas su versatilidad a la hora de personalizar o bien escribir m√≥dulos, a continuaci√≥n estudiaremos un poco como extender el comportamiento y la vista de los m√≥dulos el que considero como el primer paso para aprender a personalizar a trytond a nivel de codigo, asumo que se tiene conocimiento de Python, Tryton ERP y desarrollo de software en general.
Nuestra primera tarea es extender el modulo party y adicionar el campo CIIU."><meta itemprop=datePublished content="2023-06-20T16:47:56-05:00"><meta itemprop=dateModified content="2023-06-20T16:47:56-05:00"><meta itemprop=wordCount content="1315"><meta itemprop=keywords content><link media=screen rel=stylesheet href=http://bit4bit.github.io/css/common.css><link media=screen rel=stylesheet href=http://bit4bit.github.io/css/content.css><title>Escribiendo un Modulo de Tryton ERP Fundamentos 1 - Bit4bit Integraciones</title><meta name=twitter:card content="summary"><meta name=twitter:title content="Escribiendo un Modulo de Tryton ERP Fundamentos 1"><meta name=twitter:description content="Tryton ERP es un excelente framework y mas su versatilidad a la hora de personalizar o bien escribir m√≥dulos, a continuaci√≥n estudiaremos un poco como extender el comportamiento y la vista de los m√≥dulos el que considero como el primer paso para aprender a personalizar a trytond a nivel de codigo, asumo que se tiene conocimiento de Python, Tryton ERP y desarrollo de software en general.
Nuestra primera tarea es extender el modulo party y adicionar el campo CIIU."><link rel=stylesheet href=http://bit4bit.github.io/css/single.css></head><body><div id=wrapper><header id=header><h1><a href=http://bit4bit.github.io/>Bit4bit Integraciones</a></h1><nav><span class=nav-bar-item><a class=link href=/>Post</a></span>
<span class=nav-bar-item><a class=link href=/post/>Archives</a></span>
<span class=nav-bar-item><a class=link href=/about/>About</a></span></nav></header><main id=main class=post><h1>Escribiendo un Modulo de Tryton ERP Fundamentos 1</h1><article class=content><p>Tryton ERP es un excelente framework y mas su versatilidad a la hora
de personalizar o bien escribir m√≥dulos, a continuaci√≥n estudiaremos
un poco como extender el comportamiento y la vista de los m√≥dulos el que considero
como el primer paso para aprender a personalizar a trytond a nivel de codigo,
asumo que se tiene conocimiento de Python, Tryton ERP y desarrollo de software en general.</p><p>Nuestra primera tarea es extender el modulo <a href=https://docs.tryton.org/projects/modules-party/en/latest/index.html>party</a>
y adicionar el campo <a href=https://www.dane.gov.co/files/sen/nomenclatura/ciiu/CIIU_Rev_4_AC2020.pdf>CIIU</a>.</p><h2 id=creaci√≥n-del-modulo>Creaci√≥n del modulo</h2><p>Primero instalamos dependencias necesarias para el desarrollo del m√≥dulo.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>pip3 install <span style=color:teal>trytond</span><span style=font-weight:700>==</span>6.8.0 --user
</span></span><span style=display:flex><span>pip3 install proteus --user
</span></span></code></pre></div><p>Ahora creamos el m√≥dulo usando plantilla por medio de <a href=https://www.cookiecutter.io/>cookiecutter</a></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cookiecutter git+https://gitlab.com/bit4bit/cookiecutter-tryton-module.git --directory template --no-input <span style=color:teal>module_name</span><span style=font-weight:700>=</span>party_ciiu <span style=color:teal>version</span><span style=font-weight:700>=</span>6.8.0 <span style=color:teal>test_with_scenario</span><span style=font-weight:700>=</span>party_ciiu.rst
</span></span></code></pre></div><p>Lo anterior nos crea un directorio <code>party_ciiu</code> con la estructura de un m√≥dulo de tryton.</p><p>Activamos el m√≥dulo en modo desarrollo.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#999>cd</span> party_ciiu
</span></span><span style=display:flex><span>python3 setup.py develop --user
</span></span></code></pre></div><p>Para confirmar que el m√≥dulo este operativo ejecutamos las pruebas.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#999>cd</span> party_ciiu
</span></span><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><p>Y si todo es correcto ver√≠amos</p><pre>
Ran 22 tests in 2.268s

OK
</pre><h2 id=adici√≥n-campo-ciiu_code>Adici√≥n campo <code>ciiu_code</code></h2><p>Nos vamos a orientador durante el desarrollo de la siguiente manera:</p><ul><li>mantener el modulo todo el tiempo en operaci√≥n es decir, no deber√≠amos tener errores por mucho mas que unos minutos.</li><li>aplazar lo que mas podamos el trabajo sobre vista del modulo, ya que cuando editamos la vista se hace visible para que el usuario interactu√© con el modulo y si este esta incompleto abrimos el camino a las inconsistencias en el sistema.</li></ul><p>Para avanzar y conocer el progreso de nuestro desarrollo, procederemos de la siguiente manera:</p><ul><li>describimos los escenarios o pruebas que esperamos</li><li>ejecutamos los escenarios o pruebas</li><li>corregimos el error, aclaramos la intenci√≥n y volvemos al primer paso</li></ul><p>Vamos a empezar creando el escenario que refleje nuestro objetivo de adicionar el campo <code>ciiu_code</code></p><p><strong>tests/scenario_create_party_with_ciiu_code.rst</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rst data-lang=rst><span style=display:flex><span><span style=color:#999>===================</span>
</span></span><span style=display:flex><span><span style=color:#999>Crear Party con campo ciiu_code Scenario</span>
</span></span><span style=display:flex><span><span style=color:#999>===================</span>
</span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span>Dependencias<span style=color:#b84>::</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b84>    &gt;&gt;&gt; from proteus import Model, Wizard</span>
</span></span><span style=display:flex><span><span style=color:#b84>    &gt;&gt;&gt; from trytond.tests.tools import activate_modules
</span></span></span><span style=display:flex><span><span style=color:#b84>
</span></span></span><span style=display:flex><span><span style=color:#b84></span>Activacion de modulos<span style=color:#b84>::</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b84>    &gt;&gt;&gt; config = activate_modules(&#39;party_ciiu&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#b84>
</span></span></span><span style=display:flex><span><span style=color:#b84></span>Party con ciiu_code<span style=color:#b84>::</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b84>    &gt;&gt;&gt; Party = Model.get(&#39;party.party&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#b84>    &gt;&gt;&gt; party = Party()
</span></span></span><span style=display:flex><span><span style=color:#b84>    &gt;&gt;&gt; party.ciiu_code = &#39;0111&#39; # valor real esperados
</span></span></span><span style=display:flex><span><span style=color:#b84>    &gt;&gt;&gt; party.save()
</span></span></span><span style=display:flex><span><span style=color:#b84>    &gt;&gt;&gt; party.ciiu_code
</span></span></span><span style=display:flex><span><span style=color:#b84>    &#39;0111&#39;
</span></span></span></code></pre></div><p>ejecutamos los escenarios</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><p>y vemos nuestro primer error</p><pre>
Failed example:
    Party = Model.get('party.party')
    ...
    File "/home/bit4bit/.local/lib/python3.9/site-packages/trytond/pool.py", line 190, in get
        return self._pool[self.database_name][type][name]
    KeyError: 'party.party'
</pre><p><code>KeyError: 'party.party'</code> nos indica que estamos intentado acceder a un modelo que
no esta registrado, para corregir vamos a instalar el modulo y notificar que nuestro modulo requiere del modulo <code>party</code> para operar.</p><p>instalamos dependencia</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>pip3 install trytond-party<span style=font-weight:700>==</span>6.8.0 --user
</span></span></code></pre></div><p>indicamos a trytond que requerimos del modulo <code>party</code></p><p><strong>tryton.cfg</strong></p><pre tabindex=0><code class=language-config data-lang=config>[tryton]
version=6.8.0
depends:
    ir
    party
xml:
</code></pre><p>ejecutamos los escenarios</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><p>y vemos nuestro siguiente error</p><pre>
Failed example:
    party.ciiu_code = '0110'
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.9/doctest.py", line 1336, in __run
        exec(compile(example.source, filename, "single",
      File "<doctest scenario_create_party_ciiu_code.rst[5]>", line 1, in <module>
        party.ciiu_code = '0110'
    AttributeError: 'party.party' object has no attribute 'ciiu_code'
</pre><p><code>AttributeError: 'party.party' object has no attribute 'ciiu_code'</code> nos indica
que estamos intentando asignar un valor a un atributo que no existe en el modelo <code>party.party</code>, para corregir necesitamos este atributo en <code>party.party</code>.</p><p>Extendemos el modelo <code>party.party</code> y adicionamos el nuevo atributo.</p><p><strong>party.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> PoolMeta
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model</span> <span style=font-weight:700>import</span> fields
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>Party</span>( metaclass<span style=font-weight:700>=</span>PoolMeta):
</span></span><span style=display:flex><span>    __name__ <span style=font-weight:700>=</span> <span style=color:#b84>&#39;party.party&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ciiu_code <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Char(<span style=color:#b84>&#39;CIIU CODE&#39;</span>, required<span style=font-weight:700>=</span><span style=font-weight:700>False</span>)
</span></span></code></pre></div><p>Le indicamos a tryton el modelo que hemos extendido</p><p><strong><strong>init</strong>.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> Pool
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>.</span> <span style=font-weight:700>import</span> party
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>__all__ <span style=font-weight:700>=</span> [<span style=color:#b84>&#39;register&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>register</span>():
</span></span><span style=display:flex><span>    Pool<span style=font-weight:700>.</span>register(
</span></span><span style=display:flex><span>        party<span style=font-weight:700>.</span>Party,
</span></span><span style=display:flex><span>        module<span style=font-weight:700>=</span><span style=color:#b84>&#39;party_ciiu&#39;</span>, type_<span style=font-weight:700>=</span><span style=color:#b84>&#39;model&#39;</span>)
</span></span></code></pre></div><p>ejecutamos los escenarios</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><p>y por fin ya no tenemos el error</p><pre>
Ran 24 tests in 9.231s

OK
</pre><p>Lo anterior nos indica que ya el <code>party.party</code> tiene el nuevo atributo,
pero aun no hemos realizado una implementacion aceptable, una implementacion
aceptable es una implementaci√≥n que se ajuste a los escenarios planteados o acordados
con el cliente, en nuestro caso tomaremos como aceptable la implementaci√≥n
del <code>ciiu_code</code> cuando este valide que el <a href=https://www.dane.gov.co/files/sen/nomenclatura/ciiu/CIIU_Rev_4_AC2020.pdf>formato</a> sea el correcto y este
entre los valores esperados seg√∫n cliente.</p><p><strong>tests/test_entrada_es_opcional.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.tests.test_tryton</span> <span style=font-weight:700>import</span> ModuleTestCase, with_transaction
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> Pool
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model.exceptions</span> <span style=font-weight:700>import</span> RequiredValidationError
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>PartyCiiu_EntradasRequeridas_TestCase</span>(ModuleTestCase):
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;Test Party Ciiu module&#34;</span>
</span></span><span style=display:flex><span>    module <span style=font-weight:700>=</span> <span style=color:#b84>&#39;party_ciiu&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @with_transaction()
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>test_ciiud_code_es_opcional</span>(self):
</span></span><span style=display:flex><span>        pool <span style=font-weight:700>=</span> Pool()
</span></span><span style=display:flex><span>        Party <span style=font-weight:700>=</span> pool<span style=font-weight:700>.</span>get(<span style=color:#b84>&#39;party.party&#39;</span>)
</span></span><span style=display:flex><span>        <span style=font-weight:700>try</span>:
</span></span><span style=display:flex><span>            party, <span style=font-weight:700>=</span> Party<span style=font-weight:700>.</span>create([{}])
</span></span><span style=display:flex><span>        <span style=font-weight:700>except</span> RequiredValidationError:
</span></span><span style=display:flex><span>            self<span style=font-weight:700>.</span>fail(<span style=color:#b84>&#39;se espera campo `ciiu_code` como opcional&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>del</span> ModuleTestCase
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><p>siendo la salida de la ejecuci√≥n</p><pre>
Ran 47 tests in 12.323s

OK
</pre><p>Lo cual nos indica que no hubo errores, en nuestro caso esta prueba
nos garantiza que si por alg√∫n motivo cambia la obligatoriedad del campo
<code>ciiu_code</code> nos alerte y tomemos las acciones pertinentes.</p><p>Ahora procederemos con la validaci√≥n del campo, es recomendable partir de la entradas err√≥neas,
al iniciar con la validaci√≥n de las entradas err√≥neas se nos reduce el margen
de que el programa entre en un estado inconsistente ya que en el manejo de estas
entradas es donde usualmente se presente la mayor√≠a de inconsistencia.</p><p><strong>tests/test_ciiu_code.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.tests.test_tryton</span> <span style=font-weight:700>import</span> ModuleTestCase, with_transaction
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> Pool
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model.exceptions</span> <span style=font-weight:700>import</span> ValidationError
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>PartyCiiu_ciiu_code_TestCase</span>(ModuleTestCase):
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;Test Party Ciiu campo ciiu_code&#34;</span>
</span></span><span style=display:flex><span>    module <span style=font-weight:700>=</span> <span style=color:#b84>&#39;party_ciiu&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @with_transaction()
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>test_para_entrada_invalida_UserError</span>(self):
</span></span><span style=display:flex><span>        pool <span style=font-weight:700>=</span> Pool()
</span></span><span style=display:flex><span>        Party <span style=font-weight:700>=</span> pool<span style=font-weight:700>.</span>get(<span style=color:#b84>&#39;party.party&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        party, <span style=font-weight:700>=</span> Party<span style=font-weight:700>.</span>create([{<span style=color:#b84>&#39;name&#39;</span>: <span style=color:#b84>&#39;CIIU&#39;</span>}])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(ValidationError):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>ciiu_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;99999&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(ValidationError):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>ciiu_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;0&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(ValidationError):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>ciiu_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;9999&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>del</span> ModuleTestCase
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Traceback (most recent call last):
  File "/home/bit4bit/.local/lib/python3.9/site-packages/trytond/tests/test_tryton.py", line 223, in wrapper
    result = func(*args, **kwargs)
  File "/tmp/d20230621-16221-7fnzm8/party_ciiu/tests/test_ciiu_code.py", line 18, in test_para_entrada_invalida_UserError
    party.save()
AssertionError: ValidationError not raised
</pre><p><code>AssertionError: ValidationError not raised</code> nos indica que no se lanza el error,
ahora procederemos a corregir, como hemos visto corregir seria realizar la implementaci√≥n del c√≥digo o bien corregir un defecto.</p><p><strong>party_ciiu/party.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> PoolMeta
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model</span> <span style=font-weight:700>import</span> fields
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.i18n</span> <span style=font-weight:700>import</span> gettext
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model.exceptions</span> <span style=font-weight:700>import</span> ValidationError
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>Party</span>( metaclass<span style=font-weight:700>=</span>PoolMeta):
</span></span><span style=display:flex><span>    __name__ <span style=font-weight:700>=</span> <span style=color:#b84>&#39;party.party&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ciiu_code <span style=font-weight:700>=</span> fields<span style=font-weight:700>.</span>Char(<span style=color:#b84>&#39;CIIU CODE&#39;</span>, required<span style=font-weight:700>=</span><span style=font-weight:700>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>validate_fields</span>(cls, records, field_names):
</span></span><span style=display:flex><span>        <span style=color:#999>super</span>()<span style=font-weight:700>.</span>validate_fields(records, field_names)
</span></span><span style=display:flex><span>        cls<span style=font-weight:700>.</span>check_fields(records, field_names)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>check_fields</span>(cls, records, field_names):
</span></span><span style=display:flex><span>        <span style=font-weight:700>if</span> field_names <span style=font-weight:700>and</span> <span style=font-weight:700>not</span> (field_names <span style=font-weight:700>&amp;</span> {<span style=color:#b84>&#39;ciiu_code&#39;</span>}):
</span></span><span style=display:flex><span>            <span style=font-weight:700>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>for</span> record <span style=font-weight:700>in</span> records:
</span></span><span style=display:flex><span>            <span style=font-weight:700>if</span> <span style=font-weight:700>not</span> cls<span style=font-weight:700>.</span>allowed_ciiu_code(record<span style=font-weight:700>.</span>ciiu_code):
</span></span><span style=display:flex><span>                <span style=font-weight:700>raise</span> ValidationError(gettext(<span style=color:#b84>&#39;party_ciiu.ciiu_code_invalid&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @classmethod
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>allowed_ciiu_code</span>(cls, code):
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># solo validamos los codigos de interes para nuestra implementacion</span>
</span></span><span style=display:flex><span>        codes <span style=font-weight:700>=</span> [<span style=font-weight:700>None</span>, <span style=color:#b84>&#39;0111&#39;</span>, <span style=color:#b84>&#39;0170&#39;</span>, <span style=color:#b84>&#39;0210&#39;</span>, <span style=color:#b84>&#39;0240&#39;</span>, <span style=color:#b84>&#39;0311&#39;</span>, <span style=color:#b84>&#39;0510&#39;</span>, <span style=color:#b84>&#39;0520&#39;</span>, <span style=color:#b84>&#39;0610&#39;</span>]
</span></span><span style=display:flex><span>        <span style=font-weight:700>return</span> code <span style=font-weight:700>in</span> codes
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Ran 70 tests in 15.363s

OK
</pre><p>ya volvimos a estar estables, ahora vamos a confirmar que el <code>ciiu_code</code>
este operativo para nuestra implementacion.</p><p><strong>tests/test_ciiu_code.py</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.tests.test_tryton</span> <span style=font-weight:700>import</span> ModuleTestCase, with_transaction
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.pool</span> <span style=font-weight:700>import</span> Pool
</span></span><span style=display:flex><span><span style=font-weight:700>from</span> <span style=color:#555>trytond.model.exceptions</span> <span style=font-weight:700>import</span> ValidationError
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>class</span> <span style=color:#458;font-weight:700>PartyCiiu_ciiu_code_TestCase</span>(ModuleTestCase):
</span></span><span style=display:flex><span>    <span style=color:#b84>&#34;Test Party Ciiu campo ciiu_code&#34;</span>
</span></span><span style=display:flex><span>    module <span style=font-weight:700>=</span> <span style=color:#b84>&#39;party_ciiu&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @with_transaction()
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>test_para_entrada_valida_no_hay_error</span>(self):
</span></span><span style=display:flex><span>        pool <span style=font-weight:700>=</span> Pool()
</span></span><span style=display:flex><span>        Party <span style=font-weight:700>=</span> pool<span style=font-weight:700>.</span>get(<span style=color:#b84>&#39;party.party&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        party, <span style=font-weight:700>=</span> Party<span style=font-weight:700>.</span>create([{<span style=color:#b84>&#39;name&#39;</span>: <span style=color:#b84>&#39;CIIU Valid&#39;</span>}])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#998;font-style:italic># solo validamos los interes para nuestro cliente</span>
</span></span><span style=display:flex><span>        company_codes <span style=font-weight:700>=</span> [<span style=font-weight:700>None</span>, <span style=color:#b84>&#39;0111&#39;</span>, <span style=color:#b84>&#39;0170&#39;</span>, <span style=color:#b84>&#39;0210&#39;</span>, <span style=color:#b84>&#39;0240&#39;</span>, <span style=color:#b84>&#39;0311&#39;</span>, <span style=color:#b84>&#39;0510&#39;</span>, <span style=color:#b84>&#39;0520&#39;</span>, <span style=color:#b84>&#39;0610&#39;</span>]
</span></span><span style=display:flex><span>        <span style=font-weight:700>for</span> code <span style=font-weight:700>in</span> company_codes:
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>ciiu_code <span style=font-weight:700>=</span> code
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>    @with_transaction()
</span></span><span style=display:flex><span>    <span style=font-weight:700>def</span> <span style=color:#900;font-weight:700>test_para_entrada_invalida_UserError</span>(self):
</span></span><span style=display:flex><span>        pool <span style=font-weight:700>=</span> Pool()
</span></span><span style=display:flex><span>        Party <span style=font-weight:700>=</span> pool<span style=font-weight:700>.</span>get(<span style=color:#b84>&#39;party.party&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        party, <span style=font-weight:700>=</span> Party<span style=font-weight:700>.</span>create([{<span style=color:#b84>&#39;name&#39;</span>: <span style=color:#b84>&#39;CIIU&#39;</span>}])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(ValidationError):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>ciiu_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;99999&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(ValidationError):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>ciiu_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;0&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700>with</span> self<span style=font-weight:700>.</span>assertRaises(ValidationError):
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>ciiu_code <span style=font-weight:700>=</span> <span style=color:#b84>&#39;9999&#39;</span>
</span></span><span style=display:flex><span>            party<span style=font-weight:700>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>del</span> ModuleTestCase
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>python3 -munittest
</span></span></code></pre></div><pre>
Ran 71 tests in 15.529s

OK
</pre><p>excelente ahora que hemos validado el comportamiento aceptable por el cliente,
procedemos a activarlo en la interfaz del usuario.</p><p>le indicamos al tryton que vamos a extender las vista <code>party.party_view_tree</code> usando el archivo <code>view/party_list.xml</code> y <code>party.party_view_form</code> con el archivo <code>view/party_form.xml</code></p><p><strong>party.xml</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#999;font-weight:700>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:navy>&lt;tryton&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:navy>&lt;data&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:navy>&lt;record</span> <span style=color:teal>model=</span><span style=color:#b84>&#34;ir.ui.view&#34;</span> <span style=color:teal>id=</span><span style=color:#b84>&#34;party_view_tree&#34;</span><span style=color:navy>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:navy>&lt;field</span> <span style=color:teal>name=</span><span style=color:#b84>&#34;model&#34;</span><span style=color:navy>&gt;</span>party.party<span style=color:navy>&lt;/field&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:navy>&lt;field</span> <span style=color:teal>name=</span><span style=color:#b84>&#34;inherit&#34;</span> <span style=color:teal>ref=</span><span style=color:#b84>&#34;party.party_view_tree&#34;</span><span style=color:navy>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:navy>&lt;field</span> <span style=color:teal>name=</span><span style=color:#b84>&#34;name&#34;</span><span style=color:navy>&gt;</span>party_list<span style=color:navy>&lt;/field&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:navy>&lt;/record&gt;</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>    <span style=color:navy>&lt;record</span> <span style=color:teal>model=</span><span style=color:#b84>&#34;ir.ui.view&#34;</span> <span style=color:teal>id=</span><span style=color:#b84>&#34;party_view_form&#34;</span><span style=color:navy>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:navy>&lt;field</span> <span style=color:teal>name=</span><span style=color:#b84>&#34;model&#34;</span><span style=color:navy>&gt;</span>party.party<span style=color:navy>&lt;/field&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:navy>&lt;field</span> <span style=color:teal>name=</span><span style=color:#b84>&#34;inherit&#34;</span> <span style=color:teal>ref=</span><span style=color:#b84>&#34;party.party_view_form&#34;</span><span style=color:navy>/&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:navy>&lt;field</span> <span style=color:teal>name=</span><span style=color:#b84>&#34;name&#34;</span><span style=color:navy>&gt;</span>party_form<span style=color:navy>&lt;/field&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:navy>&lt;/record&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:navy>&lt;/data&gt;</span>
</span></span><span style=display:flex><span><span style=color:navy>&lt;/tryton&gt;</span>
</span></span></code></pre></div><p><strong>view/party_form.xml</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#999;font-weight:700>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:navy>&lt;data&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:navy>&lt;xpath</span> <span style=color:teal>expr=</span><span style=color:#b84>&#34;//page[@id=&#39;general&#39;]&#34;</span> <span style=color:teal>position=</span><span style=color:#b84>&#34;after&#34;</span><span style=color:navy>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:navy>&lt;field</span> <span style=color:teal>name=</span><span style=color:#b84>&#34;ciiu_code&#34;</span><span style=color:navy>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:navy>&lt;/xpath&gt;</span>
</span></span><span style=display:flex><span><span style=color:navy>&lt;/data&gt;</span> 
</span></span></code></pre></div><p><strong>view/party_list.xml</strong></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#999;font-weight:700>&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:navy>&lt;data&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:navy>&lt;xpath</span> <span style=color:teal>expr=</span><span style=color:#b84>&#34;//field[@name=&#39;name&#39;]&#34;</span> <span style=color:teal>position=</span><span style=color:#b84>&#34;after&#34;</span><span style=color:navy>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:navy>&lt;field</span> <span style=color:teal>name=</span><span style=color:#b84>&#34;ciiu_code&#34;</span><span style=color:navy>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:navy>&lt;/xpath&gt;</span>
</span></span><span style=display:flex><span><span style=color:navy>&lt;/data&gt;</span>
</span></span></code></pre></div><p>e informamos a tryton nuestra intenci√≥n sobre cambios a la vista, adicionando <code>party.xml</code> a la lista <code>xml</code> en <code>tryton.cfg</code></p><p><strong>tryton.cfg</strong></p><pre tabindex=0><code class=language-config data-lang=config>[tryton]
version=6.8.0
depends:
    ir
    party
xml:
    party.xml	
</code></pre><p>Para finalizar me gustar√≠a comentar acerca de como usamos los dos mecanismos que ofrece <strong>trytond</strong> para las pruebas, estos son:</p><ol><li>archivos <strong>.rst</strong> o <strong>doctests</strong></li><li>pruebas por medio de <strong>unittest</strong></li></ol><p>Usamos las pruebas <strong>doctests</strong> para verificar que el modulo opere aceptable mente en los
escenarios planteados, y usamos <strong>unittest</strong> ya para verificar en detalle el comportamiento
del modulo, dir√≠amos que es una lupa a los escenarios de <strong>doctests</strong>.</p></article><div class=paginator><a class=link href=http://bit4bit.github.io/post/mdtoapp/>‚Üê prev</a>
<a class=link target=history href="https://chiselapp.com/user/bit4bit/repository/bit4bit_website/finfo?name=content/post%2fwriting_module_trytond_basics_1.md">history</a>
<a class=link href="https://chiselapp.com/user/bit4bit/repository/bit4bit_website/raw?ci=tip&filename=content/post%2fwriting_module_trytond_basics_1.md">source</a>
<a></a></div><div class=comment></div></main><footer id=footer><div><span>¬© 2019</span> - <span>2023</span></div><div><span>Powered by</span>
<a class=link href=https://gohugo.io/>Hugo</a>
<span>üç¶ Theme</span>
<a class=link href=https://github.com/queensferryme/hugo-theme-texify>TeXify</a></div><div class=footnote><span>Follow me on <a class=link href=https://github.com/bit4bit>GitHub</a> or
<a class=link href=http://chiselapp.com/user/bit4bit/>Chiselapp</a> or
<a class=link href=/index.xml>RSS</a> |
<a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a><pre>fossil open https://chiselapp.com/user/bit4bit/repository/bit4bit_website --workdir website</pre></span></div></footer></div></body></html>